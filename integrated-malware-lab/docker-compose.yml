version: '3.8'

services:
  # ============================================================================
  # INetSim - DNS Server + Basic Services (SMTP, FTP, HTTP fallback)
  # ============================================================================
  inetsim:
    build:
      context: ./inetsim
      dockerfile: Dockerfile
    container_name: inetsim-server
    hostname: inetsim
    
    # Cấp quyền để chạy iptables và network config
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    
    ports:
      # DNS (Primary)
      - "53:53/udp"
      - "53:53/tcp"
      
      # SMTP Service
      - "25:25/tcp"
      
      # FTP Service
      - "21:21/tcp"
      
      # HTTP Fallback (mapped from container port 80)
      - "8080:80/tcp"
      
      # HTTPS Fallback (mapped from container port 443)
      - "8443:443/tcp"
    
    # Static IP trong subnet 172.20.0.0/24
    networks:
      malware_lab:
        ipv4_address: 172.20.0.2
    
    volumes:
      # INetSim configuration
      - ./inetsim/config/inetsim.conf:/etc/inetsim/inetsim.conf:ro
      - ./inetsim/config/fakefile.conf:/etc/inetsim/fakefile.conf:ro
      
      # Logs
      - ./shared/logs/inetsim:/var/log/inetsim
      
      # Shared config
      - ./shared/config:/shared/config:ro
    
    environment:
      - INETSIM_LOG_LEVEL=debug
      - DNS_SERVER=172.20.0.2
    
    entrypoint: /entrypoint.sh
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "nc", "-u", "-z", "127.0.0.1", "53"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    depends_on:
      - fakenet-ng

  # ============================================================================
  # FakeNet-NG - HTTP/HTTPS Traffic Analysis & Advanced Service Simulation
  # ============================================================================
  fakenet-ng:
    build:
      context: ./fakenet-ng
      dockerfile: Dockerfile
    container_name: fakenet-ng-server
    hostname: fakenet-ng
    
    # Cấp quyền cho network manipulation
    cap_add:
      - NET_ADMIN
      - SYS_ADMIN
      - NET_RAW
    
    ports:
      # HTTP (Port 80) - sẽ được chuyển hướng từ malware container
      - "80:80/tcp"
      
      # HTTPS (Port 443)
      - "443:443/tcp"
      
      # Secondary HTTP port
      - "8080:8080/tcp"
      
      # Secondary HTTPS port
      - "8443:8443/tcp"
      
      # HTTP Alternate Ports
      - "8000:8000/tcp"
      - "8888:8888/tcp"
      
      # Custom service ports
      - "9000:9000/tcp"
    
    # Static IP trong subnet 172.20.0.0/24
    networks:
      malware_lab:
        ipv4_address: 172.20.0.3
    
    volumes:
      # FakeNet-NG configuration
      - ./fakenet-ng/config/fakenet.conf:/etc/fakenet/fakenet.conf:ro
      - ./fakenet-ng/config/responses_config.py:/opt/fakenet-ng/responses_config.py:ro
      
      # SSL certificates
      - ./fakenet-ng/config/certs:/opt/fakenet-ng/certs:ro
      
      # Logs
      - ./shared/logs/fakenet-ng:/var/log/fakenet-ng
      
      # Shared config
      - ./shared/config:/shared/config:ro
    
    environment:
      - FAKENET_DEBUG=1
      - FAKENET_LOG_LEVEL=INFO
      - DNS_SERVER=172.20.0.2
      - INETSIM_IP=172.20.0.2
    
    entrypoint: /entrypoint.sh
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "80"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ============================================================================
  # Network Isolation Container - Optional untuk sandbox các ứng dụng được phân tích
  # ============================================================================
  # analyzer:
  #   image: ubuntu:22.04
  #   container_name: malware-analyzer
  #   networks:
  #     - malware_lab
  #   depends_on:
  #     - inetsim
  #     - fakenet-ng
  #   dns:
  #     - 172.20.0.2  # INetSim DNS server
  #   privileged: true
  #   volumes:
  #     - ./shared/logs/malware:/logs
  #     - ./samples:/samples:ro
  #   stdin_open: true
  #   tty: true

# ============================================================================
# Định nghĩa mạng riêng biệt với subnet cố định
# ============================================================================
networks:
  malware_lab:
    driver: bridge
    driver_opts:
      # Tăng MTU để hỗ trợ các gói packet lớn
      com.docker.network.driver.mtu: 1500
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
          # IP range: 172.20.0.2 - 172.20.0.254
          # 172.20.0.2: INetSim
          # 172.20.0.3: FakeNet-NG
          # 172.20.0.10-254: Available for other containers

volumes:
  inetsim_logs:
  fakenet_logs:
