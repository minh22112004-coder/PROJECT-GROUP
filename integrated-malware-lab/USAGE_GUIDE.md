# Usage Guide - Complete Reference for Using the Integrated Malware Lab

**Version:** 1.0.0  
**Last Updated:** 2024  
**Status:** ‚úÖ Production Ready  

---

## üìã Table of Contents

1. [Quick Start](#quick-start)
2. [Installation Methods](#installation-methods)
3. [Basic Operations](#basic-operations)
4. [Advanced Usage](#advanced-usage)
5. [Testing Scenarios](#testing-scenarios)
6. [Monitoring & Analysis](#monitoring--analysis)
7. [Troubleshooting](#troubleshooting)
8. [Examples](#examples)

---

## ‚ö° Quick Start

### One-Line Setup (Recommended)
```bash
cd integrated-malware-lab && bash quickstart.sh
```

**What it does:**
1. Checks Docker/Docker Compose installation
2. Creates necessary directories
3. Builds Docker images
4. Starts containers
5. Configures host routing
6. Verifies system health

**Expected Time:** 2-3 minutes

### Expected Output
```
‚úì Docker version: 20.10.12
‚úì Docker Compose version: 1.29.2
‚úì Building images...
  - Building inetsim image... Done
  - Building fakenet-ng image... Done
‚úì Starting containers...
  - Starting inetsim server... Done
  - Starting fakenet-ng server... Done
‚úì Setting up routing...
‚úì System Health Check:
  - INetSim (DNS): ‚úì Healthy
  - FakeNet-NG (HTTP): ‚úì Healthy
‚úì Lab is ready! Test with:
  nslookup example.com localhost:53
  curl http://localhost:8080
```

---

## üöÄ Installation Methods

### Method 1: Using Quickstart Script (Fastest)
```bash
# Navigate to lab directory
cd integrated-malware-lab

# Run quickstart
bash quickstart.sh

# Verify
docker-compose ps
```

### Method 2: Using Makefile (Easiest)
```bash
# Navigate to lab directory
cd integrated-malware-lab

# One command
make quickstart

# Or step by step
make build      # Build images
make up         # Start containers
make setup      # Configure routing
make status     # Verify running
```

### Method 3: Manual Docker Commands
```bash
# Build images
docker-compose build

# Start containers in foreground (see logs immediately)
docker-compose up

# Or start in background
docker-compose up -d

# Setup routing (in another terminal if foreground)
sudo bash scripts/setup-routing.sh

# Verify
docker-compose ps
```

### Method 4: Docker Hub Image (Future)
```bash
# Pull pre-built images (when available)
docker pull username/inetsim:latest
docker pull username/fakenet-ng:latest

# Run with docker-compose
docker-compose up -d
```

---

## üéÆ Basic Operations

### Start the Lab
```bash
# Start all services
docker-compose up -d

# Or use Makefile
make up

# Or use quickstart
bash quickstart.sh
```

### Stop the Lab
```bash
# Stop containers but keep them
docker-compose stop

# Or remove containers entirely
docker-compose down

# Or use Makefile
make down
```

### Check Status
```bash
# See running containers
docker-compose ps

# Or use Makefile
make ps
make status

# Or short form
make stat
```

### View Logs
```bash
# All services
docker-compose logs

# INetSim only
docker-compose logs inetsim

# FakeNet-NG only
docker-compose logs fakenet-ng

# Follow in real-time
docker-compose logs -f

# Last 20 lines
docker-compose logs --tail=20

# Or use Makefile
make logs
make logs-inetsim
make logs-fakenet
```

### Restart Services
```bash
# Restart one service
docker-compose restart inetsim
docker-compose restart fakenet-ng

# Restart all
docker-compose restart

# Or with Makefile
make restart
```

---

## üîß Advanced Usage

### Access Container Shell
```bash
# INetSim shell
docker-compose exec inetsim bash

# FakeNet-NG shell
docker-compose exec fakenet-ng bash

# Run specific command
docker-compose exec inetsim ps aux
docker-compose exec fakenet-ng netstat -tlnp
```

### Monitor Resources
```bash
# Real-time statistics
docker stats

# Docker Compose specific
docker-compose exec inetsim df -h
docker-compose exec fakenet-ng free -h

# Or use Makefile
make monitor
```

### View Configuration Files
```bash
# INetSim config
docker-compose exec inetsim cat /etc/inetsim/inetsim.conf

# FakeNet-NG config
docker-compose exec fakenet-ng cat /opt/fakenet-ng/fakenet.conf

# Response handlers
docker-compose exec fakenet-ng cat /opt/fakenet-ng/responses_config.py
```

### Rebuild Images
```bash
# Rebuild without cache (force fresh build)
docker-compose build --no-cache

# Rebuild specific service
docker-compose build --no-cache inetsim
docker-compose build --no-cache fakenet-ng

# Rebuild and restart
docker-compose up -d --build

# Or with Makefile
make build-fresh
make rebuild
```

### Access Log Files
```bash
# INetSim logs on host
cat shared/logs/inetsim/inetsim.log

# FakeNet-NG logs on host
cat shared/logs/fakenet-ng/traffic.log

# Or from container
docker-compose exec inetsim tail -f /var/log/inetsim/inetsim.log
docker-compose exec fakenet-ng tail -f /var/log/fakenet-ng/traffic.log
```

### Capture Network Traffic
```bash
# Capture to file
docker-compose exec fakenet-ng tcpdump -i any -w /var/log/fakenet-ng/capture.pcap

# In another terminal, generate traffic
curl http://localhost:8080

# Stop capture (Ctrl+C in first terminal)

# Copy to host for analysis
docker cp fakenet-ng:/var/log/fakenet-ng/capture.pcap ./traffic.pcap

# Analyze with tshark
tshark -r traffic.pcap

# Or open in Wireshark (on your machine)
wireshark traffic.pcap
```

---

## üß™ Testing Scenarios

### Scenario 1: Malware DNS Beaconing

**Objective:** Test DNS interception and response injection

```bash
# Test single DNS query
nslookup c2.server localhost:53

# Expected output
# Server:         127.0.0.1
# Address:        127.0.0.1#53
# Name:           c2.server
# Address:        172.20.0.2

# Simulate multiple queries (malware beaconing pattern)
for i in {1..5}; do
    echo "Query $i:"
    nslookup beacon$i.c2.server localhost:53 | grep "Address"
    sleep 1
done

# Check logs
docker-compose logs inetsim | grep "DNS\|c2.server"
```

### Scenario 2: Malware HTTP Command & Control

**Objective:** Test HTTP interception and custom response injection

```bash
# Test HTTP request
curl -v http://localhost:8080/admin

# Or with custom headers
curl -v -H "User-Agent: Malware/1.0" \
       -H "X-Command: status" \
       http://localhost:8080/api/command

# Simulate file download
curl -O http://localhost:8080/payload.exe

# Simulate POST request
curl -X POST -d "data=infected" \
     http://localhost:8080/report

# Check response
curl -s http://localhost:8080 | head -20

# Check logs
docker-compose logs fakenet-ng | grep "payload\|report"
```

### Scenario 3: HTTPS Traffic Interception

**Objective:** Test HTTPS interception with self-signed certificate

```bash
# Test HTTPS (ignore certificate warnings)
curl -k https://localhost:8443

# With verbose output
curl -k -v https://localhost:8443

# Capture certificate information
openssl s_client -connect localhost:8443 -showcerts

# Expected: Self-signed certificate from FakeNet-NG
```

### Scenario 4: FTP File Server

**Objective:** Test FTP service and file serving

```bash
# Test FTP connectivity
nc -zv localhost 21

# Or with curl
curl ftp://admin:admin@localhost:21/

# List files
curl ftp://admin:admin@localhost:21/ -l

# Download file
curl ftp://admin:admin@localhost:21/malware.exe -O

# Check logs
docker-compose logs inetsim | grep "FTP\|RETR"
```

### Scenario 5: SMTP Email Service

**Objective:** Test SMTP service

```bash
# Test SMTP connectivity
nc -zv localhost 25

# Send test email
telnet localhost 25
# At telnet prompt, type:
# EHLO localhost
# MAIL FROM:<sender@test.com>
# RCPT TO:<recipient@test.com>
# DATA
# Subject: Test Email
# Test message
# .
# QUIT

# Or using a script
{
  echo "EHLO localhost"
  sleep 1
  echo "MAIL FROM:<from@test.com>"
  sleep 1
  echo "RCPT TO:<to@test.com>"
  sleep 1
  echo "DATA"
  sleep 1
  echo "Subject: Test"
  echo "Body"
  echo "."
  sleep 1
  echo "QUIT"
} | timeout 10 nc localhost 25

# Check logs
docker-compose logs inetsim | grep "SMTP\|MAIL"
```

### Scenario 6: Comprehensive Malware Simulation

**Objective:** Simulate realistic malware behavior

```bash
#!/bin/bash
# Malware simulation script

echo "=== Simulating Malware Behavior ==="

# Step 1: DNS lookup for C2 server
echo "1. DNS beam-out to C2..."
nslookup c2-server.io localhost:53

# Step 2: HTTP command fetch
echo "2. Fetching commands..."
curl -s -A "Mozilla/5.0" http://localhost:8080/api/cmd?id=12345 | head -c 100

# Step 3: File download (payload)
echo "3. Downloading payload..."
curl -s http://localhost:8080/update.exe -o /tmp/update.exe

# Step 4: Data exfil simulation
echo "4. Sending data..."
curl -X POST -d "data=$(uname -a)" http://localhost:8080/report

# Step 5: Check all logs
echo "5. Checking lab logs:"
echo "=== INetSim DNS log ==="
docker-compose logs inetsim | grep "c2-server" | tail -5

echo "=== FakeNet-NG HTTP log ==="
docker-compose logs fakenet-ng | grep -E "cmd|update|report" | tail -5

echo "=== Malware behavior captured ==="
```

Run it:
```bash
bash malware_sim.sh
```

---

## üìä Monitoring & Analysis

### Real-Time Monitoring

```bash
# Docker resource usage
docker stats

# Network connections
netstat -tlnp | grep -E "53|25|21|8080|8443"

# Process monitoring in container
docker-compose exec inetsim top -b -n 1

# Disk usage
du -sh shared/logs/*

# Network traffic
iftop -n
```

### Analysis Commands

```bash
# Count DNS queries
grep "DNS query" shared/logs/inetsim/inetsim.log | wc -l

# Count HTTP requests
grep "HTTP request" shared/logs/fakenet-ng/traffic.log | wc -l

# Analyze user agents
grep "User-Agent" shared/logs/fakenet-ng/traffic.log | sort | uniq -c

# Analyze requested files
grep "GET\|POST" shared/logs/fakenet-ng/traffic.log | \
  sed 's/.*\(GET\|POST\) \([^ ]*\).*/\2/' | sort | uniq -c

# Find suspicious patterns
grep -i "password\|admin\|payload" shared/logs/*/

# Timeline of events
grep "^\[" shared/logs/*/*.log | sort
```

### Report Generation

```bash
# Generate comprehensive report
{
    echo "=== System Status Report ==="
    date
    echo ""
    echo "=== Container Status ==="
    docker-compose ps
    echo ""
    echo "=== Recent DNS Queries ==="
    tail -20 shared/logs/inetsim/inetsim.log | grep DNS
    echo ""
    echo "=== Recent HTTP Requests ==="
    tail -20 shared/logs/fakenet-ng/traffic.log
    echo ""
    echo "=== System Resources ==="
    docker stats --no-stream
} > malware_lab_report_$(date +%Y%m%d_%H%M%S).txt

cat malware_lab_report_*.txt
```

---

## üêõ Troubleshooting

### Common Issues

#### Issue 1: "Port already in use"
```bash
# Find what's using the port
sudo lsof -i :8080
sudo lsof -i :53

# Kill the process
sudo kill -9 <PID>

# Or change port mapping in docker-compose.yml
# Edit: ports: - "9090:80" (instead of 8080:80)
```

#### Issue 2: "DNS not resolving"
```bash
# Check if INetSim is running
docker-compose ps | grep inetsim

# Check DNS service inside container
docker-compose exec inetsim netstat -tlnup | grep 53

# Test DNS inside container
docker-compose exec inetsim nslookup example.com 127.0.0.1

# Check logs for errors
docker-compose logs inetsim | grep -i error
```

#### Issue 3: "Connection refused"
```bash
# Verify containers are running
docker-compose ps

# Check if routing is configured
sudo iptables -t nat -L -n -v | grep 80

# If not, setup routing again
sudo bash scripts/setup-routing.sh
```

#### Issue 4: "Permission denied" (routing)
```bash
# Must use sudo for routing
sudo bash scripts/setup-routing.sh

# Check if successful
sudo iptables -t nat -L -n | head -20
```

#### Issue 5: "Disk space full"
```bash
# Check disk usage
du -sh shared/logs/

# Clear old logs
rm -f shared/logs/inetsim/*.log
rm -f shared/logs/fakenet-ng/*.log

# Or rotate logs
docker-compose exec inetsim bash -c 'mv /var/log/inetsim/inetsim.log /var/log/inetsim/inetsim.log.old'

# Restart to create new log
docker-compose restart inetsim
```

### Emergency Procedures

```bash
# Complete system reset
docker-compose down
docker-compose rm -f
sudo bash scripts/cleanup-routing.sh

# Wait a moment
sleep 5

# Restart
docker-compose up -d
sudo bash scripts/setup-routing.sh

# Verify
docker-compose ps
```

---

## üí° Examples

### Example 1: Analyze Traffic from Specific Host

```bash
# Generate traffic from malware simulation
malware_sim() {
    for i in {1..10}; do
        curl -s http://localhost:8080/beacon?id=test$i &
        nslookup malware.test localhost:53 > /dev/null &
    done
    wait
}

# Run simulation
malware_sim

# Analyze traffic
echo "DNS traffic:"
grep "malware.test" shared/logs/inetsim/inetsim.log

echo "HTTP traffic:"
grep "beacon" shared/logs/fakenet-ng/traffic.log
```

### Example 2: Stress Test the Lab

```bash
#!/bin/bash
# stress_test.sh

echo "Starting stress test..."

# DNS stress (100 parallel queries)
for i in {1..100}; do
    dig test$i.example.com @localhost > /dev/null 2>&1 &
done
echo "‚úì 100 DNS queries sent"

# HTTP stress (50 concurrent connections)
for i in {1..50}; do
    curl -s http://localhost:8080 > /dev/null &
done
echo "‚úì 50 HTTP requests sent"

# Wait for all background tasks
wait

# Monitor results
echo "Stress test complete. Checking:"
docker stats --no-stream
```

Run it:
```bash
bash stress_test.sh
```

### Example 3: Extract Malware Communication Pattern

```bash
# Create analysis script
cat > analyze_malware.sh << 'EOF'
#!/bin/bash

echo "=== Malware Communication Analysis ==="

echo "DNS Queries:"
grep -o 'query for [^ ]*' shared/logs/inetsim/inetsim.log | \
  sed 's/query for //' | sort | uniq -c | sort -rn | head -10

echo ""
echo "HTTP Endpoints:"
grep -o 'GET [^ ]*' shared/logs/fakenet-ng/traffic.log | \
  sed 's/GET //' | sort | uniq -c | sort -rn | head -10

echo ""
echo "User Agents:"
grep -o 'User-Agent: [^"]*' shared/logs/fakenet-ng/traffic.log | \
  sed 's/User-Agent: //' | sort | uniq -c | sort -rn

echo ""
echo "File Downloads:"
grep -o '\(exe\|dll\|zip\|pdf\)' shared/logs/fakenet-ng/traffic.log | \
  sort | uniq -c
EOF

bash analyze_malware.sh
```

### Example 4: Set Up for Red Teaming Exercise

```bash
# Scenario: Simulate red team attack
echo "Setting up red team lab environment..."

# 1. Start fresh
docker-compose down
docker-compose up -d

# 2. Wait for services
sleep 10

# 3. Verify services
docker-compose ps

# 4. Display important ports
echo "Lab is ready on:"
echo "  DNS:   localhost:53"
echo "  HTTP:  localhost:8080"
echo "  HTTPS: localhost:8443"
echo "  SMTP:  localhost:25"
echo "  FTP:   localhost:21"

# 5. Create dedicated log file
echo "Logging to: red_team_exercise_$(date +%Y%m%d_%H%M%S).log"

# 6. Ready
echo "All systems operational. Ready for testing."
```

---

## üìù Quick Reference

### Command Cheat Sheet

| Task | Command |
|------|---------|
| Start | `make up` or `bash quickstart.sh` |
| Stop | `make down` |
| Status | `make ps` |
| Logs | `make logs` |
| Test DNS | `nslookup example.com localhost:53` |
| Test HTTP | `curl http://localhost:8080` |
| Test HTTPS | `curl -k https://localhost:8443` |
| Test FTP | `curl ftp://admin:admin@localhost:21/` |
| View Config | `docker-compose exec inetsim cat /etc/inetsim/inetsim.conf` |
| Monitor | `docker stats` |
| Shell | `docker-compose exec inetsim bash` |
| Rebuild | `docker-compose build --no-cache` |
| Restart | `docker-compose restart` |
| Cleanup | `make clean` |

### Path Reference

| Resource | Path |
|----------|------|
| Config | `inetsim/config/inetsim.conf` |
|  | `fakenet-ng/config/fakenet.conf` |
| Logs | `shared/logs/inetsim/` |
|  | `shared/logs/fakenet-ng/` |
| Scripts | `scripts/` |
| Docs | `docs/` |

---

## üéì Further Learning

- **Setup:** [SETUP_GUIDE.md](docs/SETUP_GUIDE.md)
- **Architecture:** [ARCHITECTURE.md](docs/ARCHITECTURE.md)
- **Troubleshooting:** [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)
- **Configuration:** [CONFIGURATION_REFERENCE.md](CONFIGURATION_REFERENCE.md)
- **Testing:** [TESTING_GUIDE.md](TESTING_GUIDE.md)
- **Changes:** [CHANGES_SUMMARY.md](CHANGES_SUMMARY.md)

---

**Ready to analyze malware? Start with:** `bash quickstart.sh`

‚úÖ All systems operational. Happy analyzing!
