.PHONY: help build up down restart logs test clean setup health status

# Colors for output
BLUE=\033[0;34m
GREEN=\033[0;32m
RED=\033[0;31m
NC=\033[0m # No Color

help: ## Show this help message
	@echo "$(BLUE)Integrated Malware Analysis Lab - Commands$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(GREEN)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "Examples:"
	@echo "  make build          # Build Docker images"
	@echo "  make up             # Start all services"
	@echo "  make status         # Check running services"
	@echo "  make logs           # View real-time logs"
	@echo "  make test           # Run connectivity tests"
	@echo ""

# Build targets
build: ## Build Docker images
	@echo "$(BLUE)Building Docker images...$(NC)"
	docker-compose build --no-cache
	@echo "$(GREEN)✓ Build complete$(NC)"

rebuild: ## Rebuild images from scratch
	@echo "$(BLUE)Full rebuild...$(NC)"
	docker system prune -f
	docker-compose down
	docker-compose build --no-cache
	@echo "$(GREEN)✓ Rebuild complete$(NC)"

# Startup targets
up: ## Start all services
	@echo "$(BLUE)Starting Malware Analysis Lab...$(NC)"
	docker-compose up -d
	@echo "$(BLUE)Waiting for services to initialize...$(NC)"
	sleep 5
	@make status
	@echo "$(GREEN)✓ Lab started successfully$(NC)"
	@echo ""
	@echo "Next: Run 'make setup' to configure host routing"

setup: ## Configure host network routing
	@echo "$(BLUE)Configuring host routing (requires sudo)...$(NC)"
	sudo bash scripts/setup-routing.sh
	@echo "$(GREEN)✓ Routing configured$(NC)"

quickstart: build up setup test ## Complete setup from scratch
	@echo "$(GREEN)✓ Quickstart complete! Lab is ready$(NC)"

# Status & monitoring
status: ## Show container status
	@docker-compose ps
	@echo ""
	@echo "$(BLUE)Network Configuration:$(NC)"
	@docker network inspect malware_lab 2>/dev/null | grep -E "Gateway|Subnet" || echo "Network not ready"

logs: ## Show live logs (Ctrl+C to exit)
	docker-compose logs -f

logs-inetsim: ## Show INetSim logs
	docker-compose logs -f inetsim

logs-fakenet: ## Show FakeNet-NG logs
	docker-compose logs -f fakenet-ng

health: ## Check service health
	@echo "$(BLUE)Health Check:$(NC)"
	@echo ""
	@echo "INetSim DNS:"
	@docker exec inetsim-server nc -u -zv 127.0.0.1 53 2>&1 | grep -E "succeeded|Connection" || echo "DNS not responding"
	@echo ""
	@echo "FakeNet-NG HTTP:"
	@docker exec fakenet-ng-server nc -zv 127.0.0.1 80 2>&1 | grep -E "succeeded|Connection" || echo "HTTP not responding"

test: ## Run connectivity tests
	@echo "$(BLUE)Running connectivity tests...$(NC)"
	bash scripts/test-connectivity.sh

# Control targets
stop: ## Stop all services
	@echo "$(BLUE)Stopping services...$(NC)"
	docker-compose stop
	@echo "$(GREEN)✓ Services stopped$(NC)"

restart: ## Restart all services
	@echo "$(BLUE)Restarting services...$(NC)"
	docker-compose restart
	@sleep 3
	@make status

restart-inetsim: ## Restart INetSim
	@echo "$(BLUE)Restarting INetSim...$(NC)"
	docker-compose restart inetsim

restart-fakenet: ## Restart FakeNet-NG
	@echo "$(BLUE)Restarting FakeNet-NG...$(NC)"
	docker-compose restart fakenet-ng

# Data management
clear-logs: ## Clear all logs
	@echo "$(YELLOW)Clearing logs...$(NC)"
	rm -rf shared/logs/*
	mkdir -p shared/logs/inetsim shared/logs/fakenet-ng
	@echo "$(GREEN)✓ Logs cleared$(NC)"

backup-logs: ## Backup logs to tar.gz
	@echo "$(BLUE)Backing up logs...$(NC)"
	@tar -czf malware-analysis-backup-$$(date +%Y%m%d-%H%M%S).tar.gz shared/logs/
	@echo "$(GREEN)✓ Backup created$(NC)"

# Cleanup targets
down: ## Stop and remove containers
	@echo "$(BLUE)Stopping and removing containers...$(NC)"
	docker-compose down
	@echo "$(GREEN)✓ Containers removed$(NC)"

cleanup: ## Stop services and remove routing rules
	@echo "$(RED)Cleaning up...$(NC)"
	docker-compose down
	@echo "$(BLUE)Removing routing rules (requires sudo)...$(NC)"
	sudo bash scripts/cleanup-routing.sh
	@echo "$(GREEN)✓ Cleanup complete$(NC)"

clean: cleanup ## Alias for cleanup

purge: ## Full cleanup including volumes and networks
	@echo "$(RED)PURGE: Removing everything...$(NC)"
	docker-compose down -v
	docker network rm malware_lab 2>/dev/null || true
	sudo bash scripts/cleanup-routing.sh 2>/dev/null || true
	rm -rf shared/logs/*
	@echo "$(GREEN)✓ Complete purge finished$(NC)"

# Development targets
shell-inetsim: ## Open shell in INetSim container
	docker exec -it inetsim-server /bin/bash

shell-fakenet: ## Open shell in FakeNet-NG container
	docker exec -it fakenet-ng-server /bin/bash

exec-inetsim: ## Execute command in INetSim (usage: make exec-inetsim CMD="command")
	@docker exec -it inetsim-server $(CMD)

exec-fakenet: ## Execute command in FakeNet-NG (usage: make exec-fakenet CMD="command")
	@docker exec -it fakenet-ng-server $(CMD)

# Documentation
docs: ## Open documentation
	@echo "$(BLUE)Available documentation:$(NC)"
	@echo "  SETUP_GUIDE.md      - Installation and configuration"
	@echo "  ARCHITECTURE.md     - System design and architecture"
	@echo "  TROUBLESHOOTING.md  - Problem solving guide"
	@echo ""
	@command -v pandoc >/dev/null 2>&1 && echo "Building HTML docs..." || echo "Install pandoc to generate HTML"

readme: ## Show README
	@less README.md

# Analysis targets
analyze-dns: ## Show DNS queries
	@echo "$(BLUE)DNS Queries:$(NC)"
	@grep "DNS" shared/logs/inetsim/inetsim.log | tail -20 || echo "No DNS logs found"

analyze-http: ## Show HTTP requests
	@echo "$(BLUE)HTTP Requests:$(NC)"
	@grep -E "GET|POST|PUT|DELETE" shared/logs/fakenet-ng/traffic.log | tail -20 || echo "No HTTP logs found"

analyze-pcap: ## Show PCAP summary
	@echo "$(BLUE)Network Traffic (PCAP):$(NC)"
	@command -v tcpdump >/dev/null 2>&1 && tcpdump -r shared/logs/fakenet-ng/traffic.pcap -n | head -20 || echo "tcpdump not available"

# Monitoring
monitor: ## Monitor resource usage
	@clear
	@watch -n 2 'echo "=== Container Stats ===" && docker stats --no-stream && \
	             echo "" && echo "=== Disk Usage ===" && du -sh shared/logs/*'

disk-usage: ## Show disk usage
	@echo "$(BLUE)Disk Usage:$(NC)"
	@du -sh shared/
	@du -sh shared/logs/*

mem-usage: ## Show memory usage
	@echo "$(BLUE)Memory Usage:$(NC)"
	@docker stats --no-stream

network-stats: ## Show network statistics
	@echo "$(BLUE)Network Statistics:$(NC)"
	@for container in inetsim-server fakenet-ng-server; do \
	  echo "$$container:"; \
	  docker exec $$container ip -s link 2>/dev/null | grep -A 1 "eth0" || echo "  N/A"; \
	  echo ""; \
	done

# Utility targets
list-config: ## List configuration files
	@echo "$(BLUE)Configuration Files:$(NC)"
	@find . -name "*.conf" -o -name "*.py" | grep config | sort

version: ## Show version info
	@echo "Integrated Malware Analysis Lab"
	@echo "Version: 1.0"
	@echo "Status: Production Ready"
	@echo "Created: February 2026"
	@echo ""
	@echo "Docker version: $$(docker --version)"
	@echo "Docker Compose version: $$(docker-compose --version)"

# System info
sysinfo: ## Show system information
	@echo "$(BLUE)System Information:$(NC)"
	@echo "OS: $$(uname -s)"
	@echo "Kernel: $$(uname -r)"
	@echo "CPU cores: $$(nproc)"
	@echo "Total RAM: $$(free -h | awk '/^Mem:/ {print $$2}')"
	@echo "Available space: $$(df -h . | awk 'NR==2 {print $$4}')"
	@echo ""
	@echo "$(BLUE)Docker Info:$(NC)"
	@docker system info | grep -E "Server Version|Container|Images|Storage Driver"

# Testing targets
test-dns: ## Quick DNS test
	@echo "$(BLUE)Testing DNS...$(NC)"
	@nslookup example.com 127.0.0.1 2>&1 | tail -5 || echo "DNS test failed"

test-http: ## Quick HTTP test
	@echo "$(BLUE)Testing HTTP...$(NC)"
	@curl -s -o /dev/null -w "HTTP Status: %{http_code}\n" http://localhost 2>&1 || echo "HTTP test failed"

test-all: test ## Run all tests

# Backup & Migration
export-logs: ## Export logs for analysis
	@echo "$(BLUE)Exporting logs...$(NC)"
	@mkdir -p export
	@cp -r shared/logs export/
	@echo "$(GREEN)✓ Logs exported to export/$(NC)"

export-pcap: ## Export PCAP file
	@echo "$(BLUE)Exporting PCAP...$(NC)"
	@mkdir -p export
	@cp shared/logs/fakenet-ng/traffic.pcap export/ 2>/dev/null || echo "PCAP file not found"

# Info targets
.SILENT:version sysinfo list-config docs readme
