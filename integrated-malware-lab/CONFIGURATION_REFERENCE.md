# Configuration Reference - Detailed Explanation

## üìå Overview
Chi ti·∫øt v·ªÅ t·ª´ng file c·∫•u h√¨nh, c√°c t√πy ch·ªçn c√≥ s·∫µn, v√† l√†m th·∫ø n√†o ƒë·ªÉ customize.

---

## 1Ô∏è‚É£ docker-compose.yml

**V·ªã tr√≠:** `docker-compose.yml`  
**D√πng cho:** Orchestration t·∫•t c·∫£ containers  
**Ng√¥n ng·ªØ:** YAML  
**D√≤ng:** 185

### Key Sections

#### A. Service Definition: INetSim

```yaml
inetsim:
  build:
    context: ./inetsim
    dockerfile: Dockerfile
  container_name: inetsim-server
  hostname: inetsim
```

**Gi·∫£i th√≠ch:**
- `context`: th∆∞ m·ª•c ch·ª©a Dockerfile
- `container_name`: t√™n container c·ªë ƒë·ªãnh
- `hostname`: hostname trong Docker network

#### B. Capabilities

```yaml
  cap_add:
    - NET_ADMIN      # Network administration
    - SYS_ADMIN      # System administration
    - NET_RAW        # Raw socket access
```

**T·∫°i sao c·∫ßn:** INetSim c·∫ßn capabilities n√†y ƒë·ªÉ:
- Bind ports < 1024 (DNS, SMTP, FTP)
- Manipulate network
- Capture traffic

#### C. Port Mapping

```yaml
  ports:
    - "53:53/udp"      # DNS (UDP)
    - "53:53/tcp"      # DNS (TCP)
    - "25:25/tcp"      # SMTP
    - "21:21/tcp"      # FTP
    - "8080:80/tcp"    # HTTP (remapped)
    - "8443:443/tcp"   # HTTPS (remapped)
```

**Format:** `HOST_PORT:CONTAINER_PORT/PROTOCOL`

**T·∫°i sao:** 
- Host port 53 ‚Üí Container port 53 (DNS)
- Host port 8080 ‚Üí Container port 80 (ÈÅøÂÖç conflict)
- Host port 8443 ‚Üí Container port 443 (ÈÅøÂÖç conflict)

#### D. Static IP Assignment

```yaml
  networks:
    malware_lab:
      ipv4_address: 172.20.0.2
```

**T·∫°i sao:** 
- Cho ph√©p m·ªói service c√≥ IP ri√™ng
- Tr√°nh xung ƒë·ªôt c·ªïng (port binding tr√™n c√πng IP)
- INetSim: 172.20.0.2
- FakeNet-NG: 172.20.0.3

#### E. Volume Mounts

```yaml
  volumes:
    # Read-only config
    - ./inetsim/config/inetsim.conf:/etc/inetsim/inetsim.conf:ro
    - ./inetsim/config/fakefile.conf:/etc/inetsim/fakefile.conf:ro
    
    # Logs (read-write)
    - ./shared/logs/inetsim:/var/log/inetsim
    
    # Shared config
    - ./shared/config:/shared/config:ro
```

**Gi·∫£i th√≠ch:**
- `:ro` = read-only (config kh√¥ng th·ªÉ thay ƒë·ªïi)
- Kh√¥ng c√≥ `:ro` = read-write (logs c√≥ th·ªÉ ghi)
- Paths t∆∞∆°ng ƒë·ªëi t·ª´ th∆∞ m·ª•c docker-compose

#### F. Environment Variables

```yaml
  environment:
    - INETSIM_LOG_LEVEL=debug
    - DNS_SERVER=172.20.0.2
```

**ƒê∆∞·ª£c ƒë·ªçc b·ªüi:** Entrypoint script c√≥ th·ªÉ s·ª≠ d·ª•ng

#### G. Health Check

```yaml
  healthcheck:
    test: ["CMD", "nc", "-u", "-z", "127.0.0.1", "53"]
    interval: 10s
    timeout: 5s
    retries: 3
    start_period: 10s
```

**Gi·∫£i th√≠ch:**
- `test`: L·ªánh ki·ªÉm tra (nc = netcat)
- `interval`: Ki·ªÉm tra m·ªói 10 gi√¢y
- `timeout`: Timeout 5 gi√¢y
- `retries`: Th·∫•t b·∫°i 3 l·∫ßn = container unhealthy
- `start_period`: Ch·ªù 10 gi√¢y tr∆∞·ªõc khi ki·ªÉm tra

#### H. Depends On

```yaml
  depends_on:
    - fakenet-ng
```

**T√°c d·ª•ng:** INetSim ch·ªâ kh·ªüi ch·∫°y AFTER FakeNet-NG

### Network Definition

```yaml
networks:
  malware_lab:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
```

**Gi·∫£i th√≠ch:**
- `driver: bridge` = Docker bridge network
- Subnet: 172.20.0.0 - 172.20.0.255
- Gateway: 172.20.0.1
- INetSim: 172.20.0.2
- FakeNet-NG: 172.20.0.3

### Customization Examples

**Example 1: Change INetSim port mapping**

```yaml
# TR∆Ø·ªöC (HTTP conflict)
ports:
  - "8080:80"

# SAU (Use port 9090)
ports:
  - "9090:80"
```

Then:
```bash
curl http://localhost:9090
```

**Example 2: Add more logging volume**

```yaml
volumes:
  - ./inetsim/config/inetsim.conf:/etc/inetsim/inetsim.conf:ro
  - ./inetsim/config/fakefile.conf:/etc/inetsim/fakefile.conf:ro
  - ./shared/logs/inetsim:/var/log/inetsim
  - ./shared/logs/extra:/var/log/extra  # NEW
```

**Example 3: Add resource limits**

```yaml
inetsim:
  mem_limit: 512m      # Maximum 512MB RAM
  memswap_limit: 1g    # Total swap+RAM = 1GB
  cpus: '1'            # 1 CPU core max
```

**Apply changes:**
```bash
docker-compose down
docker-compose up -d
```

---

## 2Ô∏è‚É£ inetsim/config/inetsim.conf

**V·ªã tr√≠:** `inetsim/config/inetsim.conf`  
**D√πng cho:** INetSim service configuration  
**Ng√¥n ng·ªØ:** INI-style  
**D√≤ng:** 150+

### Key Settings

#### A. Service Binding (Ports)

```ini
service_binds 0.0.0.0:53      # DNS (UDP/TCP)
service_binds 0.0.0.0:25      # SMTP
service_binds 0.0.0.0:21      # FTP
service_binds 0.0.0.0:80      # HTTP fallback
service_binds 0.0.0.0:443     # HTTPS fallback
```

**0.0.0.0 = t·∫•t c·∫£ interfaces**

#### B. DNS Configuration

```ini
dns_default_ip 172.20.0.2              # IP response cho all queries
dns_bind_redirect_enable 1             # Catch undefined domains
dns_default_ttl 3600                   # TTL = 1 hour
```

**T√°c d·ª•ng:**
- example.com ‚Üí 172.20.0.2
- fake.domain ‚Üí 172.20.0.2
- any.thing ‚Üí 172.20.0.2

#### C. SMTP Configuration

```ini
smtp_version MTA 5.8.3         # Version string 
smtp_log_traffic 1             # Log all SMTP activity
```

#### D. FTP Configuration

```ini
ftp_version FTP 2.0.0
ftp_default_username admin
ftp_default_password admin
ftp_log_traffic 1
```

#### E. HTTP/HTTPS Configuration

```ini
http_version HTTP/1.1
http_log_traffic 1
http_fake_files 1              # Serve from fakefile.conf
```

#### F. Logging

```ini
log_file /var/log/inetsim/inetsim.log
log_level debug                # Level: error, warning, info, debug
log_traffic 1                  # Log protocol traffic
dns_log_traffic 1              # Extra DNS logging
```

### Customization Examples

**Example 1: Change DNS response time**

```ini
# TR∆Ø·ªöC
dns_default_ttl 3600    # 1 hour

# SAU
dns_default_ttl 60      # 1 minute
```

Useful khi testing DNS caching.

**Example 2: Disable HTTP files**

```ini
# TR∆Ø·ªöC
http_fake_files 1

# SAU
http_fake_files 0       # Don't serve files
```

**Example 3: Add new service (NTP)**

```ini
service_binds 0.0.0.0:123/udp
ntp_log_traffic 1
```

Then rebuild:
```bash
docker-compose build --no-cache
docker-compose up -d inetsim
```

**Example 4: Change log level**

```ini
# TR∆Ø·ªöC (verbose)
log_level debug

# SAU (minimal)
log_level warning
```

**Apply changes (without rebuild):**
```bash
# Edit file
nano inetsim/config/inetsim.conf

# Restart container (read config file again)
docker-compose restart inetsim
```

---

## 3Ô∏è‚É£ inetsim/config/fakefile.conf

**V·ªã tr√≠:** `inetsim/config/fakefile.conf`  
**D√πng cho:** Map file types to responses  
**Ng√¥n ng·ªØ:** INI-style  
**D√≤ng:** 80+

### Format

```ini
<service> <file_type> <filename> [extension]
```

### Current Mappings

#### HTTP Files

```ini
http html default.html html
http exe malware.exe exe
http zip archive.zip zip
http pdf document.pdf pdf
http jpg image.jpg jpg
```

**T√°c d·ª•ng:** Khi malware request HTTP:
- GET /malware.exe ‚Üí Return "malware.exe"
- GET /document.pdf ‚Üí Return "document.pdf"
- GET /image.jpg ‚Üí Return "image.jpg"

#### FTP Files

```ini
ftp exe software.exe exe
ftp zip files.zip zip
ftp pdf readme.pdf pdf
```

### Customization Examples

**Example 1: Add new file type**

```ini
# Add Windows batch file
http bat script.bat bat

# Add VBScript
http vbs script.vbs vbs

# Add DLL
http dll malicious.dll dll
```

**Example 2: Match specific URLs**

INetSim doesn't support URL patterns here, but FakeNet-NG does (see next section).

**Example 3: Binary files**

You can specify binary files too - they'll be served as-is from `/etc/inetsim/data/`

---

## 4Ô∏è‚É£ fakenet-ng/config/fakenet.conf

**V·ªã tr√≠:** `fakenet-ng/config/fakenet.conf`  
**D√πng cho:** FakeNet-NG service configuration  
**Ng√¥n ng·ªØ:** INI-style  
**D√≤ng:** 150+

### Key Sections

#### A. General

```ini
[General]
LogDir = /var/log/fakenet-ng
LogLevel = DEBUG                # DEBUG, INFO, WARNING, ERROR
Verbose = True                  # Extra output
```

#### B. HTTP Listener

```ini
[HTTPListener]
Port = 80
AlternativePorts = 8000, 8080, 8888, 9000
ServerString = Microsoft-IIS/10.0    # Fake server header
```

**T√°c d·ª•ng:**
- Listen on port 80
- Also on ports 8000, 8080, 8888, 9000
- Claim to be IIS server

#### C. HTTPS Listener

```ini
[HTTPSListener]
Port = 443
AlternativePorts = 8443
SSLVersion = TLSv1.2
CertificateFile = /opt/fakenet-ng/certs/server.pem
KeyFile = /opt/fakenet-ng/certs/server.key
```

#### D. Response Handling

```ini
[ResponseHandlers]
HandlerType = static
StaticContent = <html>FakeNet-NG</html>
```

#### E. Advanced Options

```ini
[Advanced]
HTPCompatibility = True            # Work like INetSim
ForwardToINetSim = True            # Fallback to INetSim
INetSimIP = 172.20.0.2
INetSimPort = 80
PacketCapture = True               # Generate PCAP
PacketCaptureFile = /var/log/fakenet-ng/traffic.pcap
```

### Customization Examples

**Example 1: Add HTTPS fallback port**

```ini
[HTTPSListener]
AlternativePorts = 8443, 9443      # Add 9443
```

**Example 2: Disable HTTPS**

```ini
[HTTPSListener]
# Comment out or remove this section
# Enabled = False
```

**Example 3: Change log level**

```ini
LogLevel = INFO      # Less verbose
# or
LogLevel = CRITICAL  # Errors only
```

**Example 4: Disable packet capture (save disk)**

```ini
[Advanced]
PacketCapture = False
```

---

## 5Ô∏è‚É£ fakenet-ng/config/responses_config.py

**V·ªã tr·ªã:** `fakenet-ng/config/responses_config.py`  
**D√πng cho:** Custom HTTP response injection  
**Ng√¥n ng·ªØ:** Python  
**D√≤ng:** 200+

### Structure

```python
RESPONSE_HANDLERS = {
    'handler_name': {
        'pattern': r'.*regex.*',        # Regex pattern to match URL
        'content': 'response_content',  # Content to return
        'content_type': 'mime/type'     # Content-Type header
    }
}
```

### Current Handlers

```python
# JSON API responses
'json': {
    'pattern': r'.*\.json.*',
    'content': '{"status": "success"}'
}

# Binary executables
'exe': {
    'pattern': r'.*\.(exe|dll|sys).*',
    'content': b'MZ\x90...'  # PE header
}

# HTML responses
'html': {
    'pattern': r'.*\.(html|htm).*|/$',
    'content': '<html>...</html>'
}

# Images, ZIP, PDF, etc.
```

### Customization Examples

**Example 1: Add fake C2 response**

```python
RESPONSE_HANDLERS = {
    # ... existing handlers ...
    
    'c2_command': {
        'pattern': r'.*api\.c2\.server/command.*',
        'content': '{"cmd": "noop", "exec": false}',
        'content_type': 'application/json'
    }
}
```

Now when malware requests:
```
GET /command?id=123
Host: api.c2.server
```

FakeNet-NG will respond:
```
{"cmd": "noop", "exec": false}
```

**Example 2: Custom update file**

```python
'malware_update': {
    'pattern': r'.*update.*\.bin',
    'content': b'FAKE_UPDATE_BINARY_CONTENT',
    'content_type': 'application/octet-stream'
}
```

**Example 3: Fake API that returns commands**

```python
'malware_c2_api': {
    'pattern': r'/api/tasks.*',
    'content': '''{
        "tasks": [
            {"id": 1, "cmd": "sleep 300"},
            {"id": 2, "cmd": "echo test"}
        ]
    }''',
    'content_type': 'application/json'
}
```

**Example 4: Check pattern before adding**

```python
import re

# Test your pattern
pattern = r'.*malware.*'
test_urls = [
    '/download/malware.exe',
    '/api/malware/report',
    '/update/software.exe'  # Should NOT match
]

for url in test_urls:
    match = re.match(pattern, url, re.IGNORECASE)
    print(f"{url}: {bool(match)}")
```

### Testing Pattern Matching

```bash
# Test from command line
python3 -c "
import re
handlers = [
    (r'.*\.exe.*', 'EXE'),
    (r'.*\.zip.*', 'ZIP'),
    (r'.*api.*', 'API')
]

test = '/download/malware.exe'
for pattern, name in handlers:
    if re.match(pattern, test, re.IGNORECASE):
        print(f'Match: {name}')
"
```

### Apply Changes

```bash
# Edit file
nano fakenet-ng/config/responses_config.py

# Restart service (no build needed)
docker-compose restart fakenet-ng

# Verify
tail -20 shared/logs/fakenet-ng/traffic.log
```

---

## 6Ô∏è‚É£ Inetsim Entrypoint Script

**V·ªã Tr√≠:** `inetsim/entrypoint.sh`  
**Ch·∫°y khi:** Container kh·ªüi ƒë·ªông  
**D√πng cho:** Initialize INetSim service  
**Ng√¥n ng·ªØ:** Bash  
**D√≤ng:** 180+

### Key Sections

#### A. Logging Setup

```bash
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}
```

T·∫°o timestamped log messages.

#### B. Directory Creation

```bash
mkdir -p "${LOG_DIR}"
chmod 755 "${LOG_DIR}"
```

Ensure log directory exists and is writable.

#### C. Configuration Verification

```bash
if ! sudo inetsim --conf "${INETSIM_CONF}" --syntax-check 2>/dev/null; then
    log_warn "Configuration may not be valid"
fi
```

Check config file before starting.

#### D. Network Configuration

```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
```

Enable IP forwarding.

#### E. Service Startup

```bash
exec inetsim --conf "${INETSIM_CONF}" --log-dir "${LOG_DIR}"
```

Start INetSim with config.

### Customization

**Example 1: Change log level**

Find this line:
```bash
sed -i 's/^#log_level.*/log_level warning/' "${INETSIM_CONF}"
```

Modify to use environment variable:
```bash
sed -i "s/^log_level.*/log_level ${INETSIM_LOG_LEVEL}/" "${INETSIM_CONF}"
```

**Example 2: Add service initialization**

```bash
# After directory creation
log_info "Initializing custom service..."
mkdir -p /var/run/inetsim
chown inetsim:inetsim /var/run/inetsim
```

**Apply changes:**
```bash
docker-compose build --no-cache inetsim
docker-compose up -d inetsim
```

---

## 7Ô∏è‚É£ FakeNet-NG Entrypoint Script

**V·ªã Tr√≠:** `fakenet-ng/entrypoint.sh`  
**Ch·∫°y khi:** Container kh·ªüi ƒë·ªông  
**D√πng cho:** Initialize FakeNet-NG service  
**Ng√¥n ng·ªØ:** Bash  
**D√≤ng:** 150+

### Key Sections

Similar to INetSim:
1. Logging setup
2. Directory creation
3. Network configuration
4. iptables rules
5. Service startup

### Special Features

#### A. HTTP Server Fallback

If FakeNet-NG fails to start:
```bash
# Fallback to simple Python HTTP server
python3 -m http.server 80
```

This ensures HTTP is always available.

#### B. Certificate Handling

```bash
# Check for SSL certificates
if [ ! -f "${FAKENET_HOME}/server.pem" ]; then
    log_warn "SSL certificate not found"
fi
```

---

## üìä Configuration Relationship Diagram

```
docker-compose.yml (Orchestration)
    ‚îú‚îÄ‚Üí inetsim/Dockerfile
    ‚îÇ        ‚îú‚îÄ‚Üí Runs inetsim/entrypoint.sh
    ‚îÇ        ‚îÇ     ‚îú‚îÄ‚Üí Reads inetsim/config/inetsim.conf
    ‚îÇ        ‚îÇ     ‚îî‚îÄ‚Üí Reads inetsim/config/fakefile.conf
    ‚îÇ        ‚îî‚îÄ‚Üí Writes to shared/logs/inetsim/
    ‚îÇ
    ‚îî‚îÄ‚Üí fakenet-ng/Dockerfile
             ‚îú‚îÄ‚Üí Runs fakenet-ng/entrypoint.sh
             ‚îÇ     ‚îú‚îÄ‚Üí Reads fakenet-ng/config/fakenet.conf
             ‚îÇ     ‚îî‚îÄ‚Üí Reads fakenet-ng/config/responses_config.py
             ‚îî‚îÄ‚Üí Writes to shared/logs/fakenet-ng/
```

---

## üîÑ Configuration Workflow

### 1. Change Configuration File

```bash
nano inetsim/config/inetsim.conf
```

### 2. Apply Change

**Option A: Without Container Restart** (if possible)
```bash
# Some changes don't need restart
docker-compose exec inetsim bash -c \
  'sed -i "s/dns_default_ttl.*/dns_default_ttl 60/" /etc/inetsim/inetsim.conf'
```

**Option B: With Container Restart** (safest)
```bash
docker-compose restart inetsim
```

**Option C: Full Rebuild** (for Dockerfile changes)
```bash
docker-compose build --no-cache inetsim
docker-compose up -d inetsim
```

### 3. Verify Change

```bash
# Check container logs
docker-compose logs inetsim | tail -20

# Test service
nslookup example.com
```

---

## ‚ö° Quick Config Changes

### Change DNS TTL
```bash
# Edit
sed -i 's/dns_default_ttl.*/dns_default_ttl 60/' inetsim/config/inetsim.conf

# Restart
docker-compose restart inetsim
```

### Change Log Level
```bash
# Edit
sed -i 's/log_level.*/log_level info/' inetsim/config/inetsim.conf
sed -i 's/LogLevel.*/LogLevel = INFO/' fakenet-ng/config/fakenet.conf

# Restart
docker-compose restart
```

### Add New Handler
```bash
# Edit responses_config.py
nano fakenet-ng/config/responses_config.py

# Add your handler
# Restart
docker-compose restart fakenet-ng
```

### Disable PCAP (save disk)
```bash
# Edit
sed -i 's/PacketCapture = True/PacketCapture = False/' fakenet-ng/config/fakenet.conf

# Restart
docker-compose restart fakenet-ng
```

---

## üö® Common Configuration Mistakes

| ‚ùå Wrong | ‚úÖ Correct |
|---------|-----------|
| `service_binds 127.0.0.1:53` | `service_binds 0.0.0.0:53` |
| `dns_default_ip localhost` | `dns_default_ip 172.20.0.2` |
| `log_level verbose` | `log_level debug` |
| Pattern: `*\.exe` | Pattern: `.*\.exe.*` |
| Port mapping: `80:80` (conflict) | Port mapping: `8080:80` |

---

## üìù Summary

- **docker-compose.yml** - Controls WHAT runs and WHERE
- **inetsim.conf** - Controls HOW INetSim behaves
- **fakefile.conf** - Maps HTTP file requests
- **fakenet.conf** - Controls HOW FakeNet-NG behaves
- **responses_config.py** - Custom HTTP responses
- **entrypoint.sh** - Initialization logic

All configuration changes can be verified in logs:
```bash
docker-compose logs --tail=50
```

---

**Next:** See [SETUP_GUIDE.md](docs/SETUP_GUIDE.md) for deployment instructions.
