#!/bin/bash

###############################################################################
# FakeNet-NG Entrypoint Script
# Chức năng: Cấu hình và khởi chạy FakeNet-NG service
# - HTTP/HTTPS Traffic Interception
# - Advanced Network Service Simulation
###############################################################################

set -e


# Màu sắc cho output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

LOG_DIR="/var/log/fakenet-ng"
FAKENET_HOME="/opt/fakenet-ng"

log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[FakeNet-NG]${NC} $1"
}

log_warn() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${YELLOW}[FakeNet-NG WARN]${NC} $1"
}

###############################################################################
# 1. Tạo log directory
###############################################################################
log_info "Tạo log directory..."
mkdir -p "${LOG_DIR}"
mkdir -p "${FAKENET_HOME}/logs"
chmod 755 "${LOG_DIR}" "${FAKENET_HOME}/logs"

###############################################################################
# 2. Cấu hình Network
###############################################################################
log_info "Cấu hình network interfaces..."

IFACE=$(ip route | grep default | awk '{print $5}' | head -n 1)
if [ -z "$IFACE" ]; then
    IFACE="eth0"
fi

log_info "Sử dụng network interface: ${IFACE}"

# Enable IP forwarding với error handling
if [ -w /proc/sys/net/ipv4/ip_forward ]; then
    echo 1 > /proc/sys/net/ipv4/ip_forward
else
    log_warn "Cannot write to /proc/sys/net/ipv4/ip_forward - skipping"
fi

###############################################################################
# 3. Khởi chạy FakeNet-NG hoặc HTTP Server Fallback
###############################################################################
log_info "=========================================="
log_info "Khởi chạy FakeNet-NG..."
log_info "=========================================="
log_info "Log directory: ${LOG_DIR}"
log_info "Services: HTTP (80), HTTPS (443), Secondary (8080, 8443)"
log_info "=========================================="

# Fallback: Run simple HTTP server
mkdir -p "${FAKENET_HOME}/www"
cat > "${FAKENET_HOME}/www/index.html" << 'HTML'
<!DOCTYPE html>
<html>
<head><title>FakeNet-NG Service</title></head>
<body>
    <h1>FakeNet-NG Service Simulation Active</h1>
    <p>HTTP/HTTPS traffic interception enabled</p>
    <p>Time: <span id="time"></span></p>
    <script>
        document.getElementById('time').innerText = new Date().toISOString();
    </script>
</body>
</html>
HTML

log_info "Running HTTP server on port 80..."
cd "${FAKENET_HOME}/www"
exec python3 -m http.server 80
