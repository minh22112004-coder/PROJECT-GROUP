#!/bin/bash

###############################################################################
# FakeNet-NG Entrypoint Script
# Chức năng: Cấu hình và khởi chạy FakeNet-NG service
# - HTTP/HTTPS Traffic Interception
# - Advanced Network Service Simulation
###############################################################################

set -e

# Màu sắc cho output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

LOG_DIR="/var/log/fakenet-ng"
CONFIG_DIR="/etc/fakenet"
FAKENET_HOME="/opt/fakenet-ng"

# Hàm log
log_info() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${GREEN}[FakeNet-NG]${NC} $1"
}

log_warn() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${YELLOW}[FakeNet-NG WARN]${NC} $1"
}

log_error() {
    echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} ${RED}[FakeNet-NG ERROR]${NC} $1"
}

###############################################################################
# 1. Tạo log directory
###############################################################################
log_info "Tạo log directory..."
mkdir -p "${LOG_DIR}"
mkdir -p "${FAKENET_HOME}/logs"
chmod 755 "${LOG_DIR}" "${FAKENET_HOME}/logs"

###############################################################################
# 2. Cấu hình Network
###############################################################################
log_info "Cấu hình network interfaces..."

# Lấy network interface chính
IFACE=$(ip route | grep default | awk '{print $5}' | head -n 1)
if [ -z "$IFACE" ]; then
    IFACE="eth0"
fi

log_info "Sử dụng network interface: ${IFACE}"

# Bật IP forwarding
if [ "$(cat /proc/sys/net/ipv4/ip_forward)" != "1" ]; then
    log_info "Bật IP forwarding..."
    echo 1 > /proc/sys/net/ipv4/ip_forward 2>/dev/null || log_warn "Không thể bật IP forwarding"
fi

###############################################################################
# 3. Cấu hình iptables để chuyển hướng traffic
###############################################################################
log_info "Cấu hình iptables rules cho HTTP/HTTPS interception..."

# Xóa các rules cũ (nếu có)
iptables -F 2>/dev/null || true
iptables -X 2>/dev/null || true
iptables -t nat -F 2>/dev/null || true
iptables -t nat -X 2>/dev/null || true

# Bật NAT
echo 1 > /proc/sys/net/ipv4/ip_forward

# Rules cho HTTP (80 -> 8080 hoặc giữ nguyên)
# Rules cho HTTPS (443 -> 8443 hoặc giữ nguyên)
# Chúng ta sẽ để FakeNet-NG listening trực tiếp trên 80 và 443

log_info "iptables rules đã được cấu hình"

###############################################################################
# 4. Cấu hình và khởi chạy FakeNet-NG
###############################################################################
log_info "=========================================="
log_info "Khởi chạy FakeNet-NG..."
log_info "=========================================="
log_info "Log directory: ${LOG_DIR}"
log_info "Services:"
log_info "  - HTTP Server: 0.0.0.0:80 (TCP)"
log_info "  - HTTPS Server: 0.0.0.0:443 (TCP)"
log_info "  - Secondary HTTP: 0.0.0.0:8080 (TCP)"
log_info "  - Secondary HTTPS: 0.0.0.0:8443 (TCP)"
log_info "  - Alternate Ports: 8000, 8888, 9000"
log_info "=========================================="

# Kiểm tra nếu FakeNet-NG service là Python script
if [ -f "${FAKENET_HOME}/fakenet.py" ]; then
    log_info "Khởi chạy FakeNet-NG từ fakenet.py..."
    cd "${FAKENET_HOME}"
    exec python3 fakenet.py 2>&1 | tee -a "${LOG_DIR}/fakenet-ng.log"
    
elif [ -d "${FAKENET_HOME}/fakenet-ng-repo" ]; then
    log_info "Khởi chạy FakeNet-NG từ git repository..."
    cd "${FAKENET_HOME}/fakenet-ng-repo"
    exec python3 fakenet.py 2>&1 | tee -a "${LOG_DIR}/fakenet-ng.log"

else
    # Nếu FakeNet-NG không cài đặt, chạy một HTTP server đơn giản
    log_warn "FakeNet-NG không được cài đặt hoàn toàn, chạy HTTP server đơn giản..."
    
    # Cài đặt http.server đơn giản
    mkdir -p "${FAKENET_HOME}/www"
    cat > "${FAKENET_HOME}/www/index.html" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>FakeNet-NG Service Simulation</title>
</head>
<body>
    <h1>FakeNet-NG Service Simulation Active</h1>
    <p>This is a fake HTTP response from FakeNet-NG</p>
    <hr>
    <p>Time: <span id="time"></span></p>
    <script>
        document.getElementById('time').innerText = new Date().toISOString();
    </script>
</body>
</html>
EOF

    # Kiểm tra định dạng cấu hình
    if command -v python3 &> /dev/null; then
        log_info "Khởi chạy HTTP server đơn giản với Python3..."
        cd "${FAKENET_HOME}/www"
        exec python3 -m http.server 80 2>&1 | tee -a "${LOG_DIR}/fakenet-ng.log"
    else
        log_error "Python3 không được cài đặt. Không thể khởi chạy server."
        # Để container chạy
        sleep infinity
    fi
fi
