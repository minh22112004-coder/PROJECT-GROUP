FROM ubuntu:22.04

# Cập nhật package manager
RUN apt-get update && apt-get install -y \
    ca-certificates \
    build-essential \
    curl \
    git \
    python3 \
    python3-pip \
    python3-dev \
    libssl-dev \
    libffi-dev \
    net-tools \
    netcat-openbsd \
    iproute2 \
    iptables \
    iputils-ping \
    dnsutils \
    wget \
    vim \
    nano \
    sudo \
    supervisor \
    tcpdump \
    scapy \
    && rm -rf /var/lib/apt/lists/*

# Tạo thư mục cho FakeNet-NG
RUN mkdir -p /opt/fakenet-ng /var/log/fakenet-ng /var/lib/fakenet-ng

# Clone FakeNet-NG từ repository
RUN cd /opt && git clone --depth 1 https://github.com/countercept/fakenet-ng.git fakenet-ng-repo || \
    mkdir -p /opt/fakenet-ng

# Cài đặt FakeNet-NG dependencies
RUN cd /opt/fakenet-ng-repo 2>/dev/null && pip3 install -q -r requirements.txt || \
    pip3 install -q \
    flask \
    requests \
    dnspython \
    pycryptodome \
    scapy \
    pyopenssl \
    cryptography

# Setup FakeNet-NG thủ công nếu clone thất bại
WORKDIR /opt/fakenet-ng

# Copy custom entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Tạo log directory
RUN mkdir -p /var/log/supervisor

# Expose ports
EXPOSE 80/tcp 443/tcp 8000/tcp 8080/tcp 8443/tcp 8888/tcp 9000/tcp

# Chạy entrypoint script
CMD ["/entrypoint.sh"]
