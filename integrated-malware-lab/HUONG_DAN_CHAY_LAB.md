# Hướng Dẫn Chạy Integrated Malware Analysis Lab

## Tổng Quan

**Integrated Malware Analysis Lab** là một giải pháp phân tích malware hoàn chỉnh sử dụng Docker để cô lập mạng an toàn. Nó kết hợp **INetSim** và **FakeNet-NG** để mô phỏng các dịch vụ mạng mà không cho phép kết nối ra bên ngoài.

### Các Dịch Vụ Được Hỗ Trợ
- **DNS** (Cổng 53) - Phân giải tên miền
- **SMTP** (Cổng 25) - Mô phỏng máy chủ email
- **FTP** (Cổng 21) - Mô phỏng server FTP
- **HTTP/HTTPS** (Cổng 80, 443) - Mô phỏng web server

---

## Yêu Cầu Hệ Thống

Để chạy lab này, bạn cần:

| Yêu Cầu | Giá Trị |
|---------|--------|
| **Docker** | Phiên bản 20.10+ |
| **Docker Compose** | Phiên bản 1.29+ |
| **Hệ Điều Hành** | Linux (Ubuntu 20.04+, CentOS 8+) |
| **CPU** | Tối thiểu 4 cores |
| **RAM** | Tối thiểu 8GB |
| **Dung Lượng Ổ Cứng** | Tối thiểu 10GB |
| **Quyền Hạn** | Root/sudo |

> **Lưu Ý**: Trên Windows hoặc macOS, bạn cần chạy trong WSL2 hoặc Docker Desktop với Linux backend.

---

## Các Bước Cài Đặt & Chạy

### 1️⃣ Kiểm Tra Điều Kiện Tiên Quyết

Trước khi bắt đầu, kiểm tra xem các công cụ cần thiết đã được cài đặt:

```bash
# Kiểm tra Docker
docker --version

# Kiểm tra Docker Compose
docker-compose --version

# Kiểm tra quyền sudo
sudo -n true && echo "Sudo OK" || echo "Cần nhập mật khẩu sudo"
```

### 2️⃣ Khởi Chạy Nhanh (Recommended - 5 phút)

Sử dụng script tự động để thiết lập tất cả trong một lệnh duy nhất:

```bash
# Điều hướng vào thư mục
cd integrated-malware-lab

# Chạy script quickstart
bash quickstart.sh
```

> **Ghi chú Windows (PowerShell/Git Bash)**: Script `quickstart.sh` sẽ tự bỏ qua `chmod` và cấu hình routing vì Windows không hỗ trợ. Các kiểm tra mạng từ host có thể không hoạt động; nếu cần, hãy kiểm tra từ bên trong container.

Script này sẽ:
✅ Kiểm tra yêu cầu hệ thống
✅ Tạo các thư mục logs
✅ Build Docker images
✅ Khởi động các containers
✅ Cấu hình routing
✅ Kiểm tra kết nối

### 3️⃣ Khởi Chạy Từng Bước (Manual)

Nếu bạn muốn kiểm soát từng bước:

```bash
# Bước 1: Tạo thư mục logs
mkdir -p shared/logs/inetsim
mkdir -p shared/logs/fakenet-ng
mkdir -p shared/config
chmod -R 777 shared/  # Bo qua tren Windows

# Bước 2: Build Docker images
docker-compose build --no-cache

# Bước 3: Khởi động containers
docker-compose up -d

# Bước 4: Chờ services khởi động
sleep 5

# Bước 5: Kiểm tra trạng thái
docker-compose ps

# Bước 6: Cấu hình routing (cần sudo)
sudo bash scripts/setup-routing.sh

# Bước 7: Kiểm tra kết nối
bash scripts/test-connectivity.sh
```

> **Windows**: Bo qua Bước 6 va 7 neu chay tren PowerShell/Git Bash. Cac buoc nay can Linux routing.

---

## Sử Dụng Makefile Commands

Nếu có Makefile, bạn có thể sử dụng các lệnh tiện lợi:

```bash
# Hiển thị tất cả các lệnh có sẵn
make help

# Build Docker images
make build

# Khởi động services
make up

# Cấu hình routing
make setup

# Xem trạng thái services
make status

# Xem logs real-time
make logs

# Chạy các kiểm tra kết nối
make test

# Dừng services
make down

# Xóa tất cả và làm sạch
make clean
```

---

## Các Lệnh Docker Compose Chủ Yếu

### Khởi Động & Dừng

```bash
# Khởi động tất cả services ở chế độ background
docker-compose up -d

# Khởi động services với logs hiển thị
docker-compose up

# Dừng tất cả services
docker-compose down

# Khởi động lại services
docker-compose restart

# Xóa containers và volumes
docker-compose down -v
```

### Kiểm Tra Trạng Thái

```bash
# Xem danh sách containers
docker-compose ps

# Xem logs real-time của tất cả services
docker-compose logs -f

# Xem logs của một service cụ thể (ví dụ: inetsim)
docker-compose logs -f inetsim

# Xem logs của fakenet-ng
docker-compose logs -f fakenet-ng
```

### Các Lệnh Khác

```bash
# Build lại images
docker-compose build --no-cache

# Xóa volumes và tạo mới
docker-compose down -v && docker-compose up -d

# Rebuild toàn bộ hệ thống
docker system prune -f && docker-compose rebuild
```

---

## Cấu Hình Routing

Để cho phép lưu lượng từ máy chủ host đi đến các containers:

```bash
# Khởi chạy script cấu hình routing
sudo bash scripts/setup-routing.sh

# Nếu cần dọn dẹp routing sau này
sudo bash scripts/cleanup-routing.sh
```

---

## Kiểm Tra Kết Nối

Để xác minh rằng tất cả dịch vụ đang hoạt động:

```bash
# Chạy script kiểm tra kết nối
bash scripts/test-connectivity.sh

# Hoặc kiểm tra thủ công:

# Kiểm tra DNS (nên trả về 172.20.0.2)
nslookup example.com 172.20.0.2

# Kiểm tra HTTP (nên trả về kết quả từ FakeNet-NG)
curl http://172.20.0.3:80

# Kiểm tra HTTPS
curl -k https://172.20.0.3:443

# Kiểm tra FTP
ftp 172.20.0.2

# Kiểm tra SMTP
telnet 172.20.0.2 25
```

---

## Xem Logs

Logs được lưu trữ tại thư mục `shared/logs/`:

```bash
# Xem tất cả logs
ls -la shared/logs/

# Xem logs của INetSim
cat shared/logs/inetsim/inetsim.log
tail -f shared/logs/inetsim/inetsim.log  # Theo dõi real-time

# Xem logs của FakeNet-NG
cat shared/logs/fakenet-ng/fakenet-ng.log
tail -f shared/logs/fakenet-ng/fakenet-ng.log  # Theo dõi real-time

# Xem PCAP capture (nếu có)
ls -la shared/logs/*.pcap
# Mở với Wireshark:
wireshark shared/logs/capture.pcap
```

---

## Kiếu Dừng Lab

```bash
# Dừng services nhưng giữ containers
docker-compose stop

# Dừng và xóa containers
docker-compose down

# Dừng, xóa containers và volumes
docker-compose down -v

# Dọn dẹp routing
sudo bash scripts/cleanup-routing.sh

# Xóa tất cả Docker images, containers, networks
docker system prune -a
```

---

## Khắc Phục Sự Cố

### Lỗi: "Docker daemon is not running"

```bash
# Khởi động Docker daemon
sudo systemctl start docker

# Hoặc nếu dùng Docker Desktop, mở ứng dụng
```

### Lỗi: "Cannot connect to Docker daemon"

```bash
# Thêm user của bạn vào nhóm docker
sudo usermod -aG docker ${USER}

# Đăng nhập lại hoặc chạy:
newgrp docker
```

### Lỗi: "Permission denied" khi cấu hình routing

```bash
# Chạy lại với sudo
sudo bash scripts/setup-routing.sh
```

### Services không khởi động được

```bash
# Xem logs chi tiết
docker-compose logs

# Xóa tất cả và khởi động lại
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d
```

### Port đã bị sử dụng

```bash
# Kiểm tra các port đang được dùng
sudo netstat -tulpn | grep LISTEN

# Hoặc sử dụng lsof
sudo lsof -i -P -n | grep LISTEN

# Dừng containers khác sử dụng port
docker-compose down
```

---

## Ví Dụ Sử Dụng

### Phân tích một file malware

```bash
# 1. Đặt file malware vào thư mục shared/samples/
mkdir -p shared/samples
cp /path/to/malware.exe shared/samples/

# 2. Chạy malware trong container (docker exec)
docker exec -it analyze ./malware.exe

# 3. Theo dõi logs và network traffic
docker-compose logs -f inetsim
docker-compose logs -f fakenet-ng

# 4. Phân tích PCAP
wireshark shared/logs/capture.pcap
```

### Tùy chỉnh cấu hình

```bash
# Chỉnh sửa cấu hình INetSim
nano inetsim/config/inetsim.conf

# Chỉnh sửa cấu hình FakeNet-NG
nano fakenet-ng/config/responses_config.py

# Rebuild containers
docker-compose build --no-cache
docker-compose up -d
```

---

## Một Số Mẹo Hữu Ích

| Mẹo | Lệnh |
|-----|------|
| **Xóa logs cũ** | `rm -rf shared/logs/*` |
| **Xem IP containers** | `docker-compose exec inetsim ip addr` |
| **Truy cập shell của container** | `docker-compose exec inetsim bash` |
| **Copy file từ container** | `docker cp <container_id>:/path/file ./` |
| **Sạch dẹp hệ thống** | `docker system prune -a --volumes` |

---

## Liên Hệ & Hỗ Trợ

- Xem tài liệu chi tiết: [README.md](README.md)
- Kiểm tra cấu hình: [docker-compose.yml](docker-compose.yml)
- Troubleshooting: Xem thư mục `docs/`

---

## Ghi Chú Quan Trọng

⚠️ **Chỉ chạy lab này trong môi trường cô lập hoặc máy ảo an toàn**
⚠️ **Không sử dụng lab này để phân tích những malware thực sự nguy hiểm**
✅ **Luôn cấu hình routing để đảm bảo cô lập mạng**
✅ **Giữ lại backups của logs quan trọng**

---

**Phiên Bản**: 1.0  
**Cập Nhật**: Tháng 2 năm 2026  
**Hệ Thống**: Integrated Malware Analysis Lab DevSecOps Edition
