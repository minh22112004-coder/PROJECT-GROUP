# Integrated Malware Analysis Lab

## Overview

A comprehensive, production-ready malware analysis sandbox solution integrating **INetSim** and **FakeNet-NG** to provide isolated network simulation for safe malware analysis without external communication.

```
┌─────────────────────────────────────┐
│  Malware Samples                    │
└────────────────┬────────────────────┘
                 │ (Isolated Network)
                 ↓
┌─────────────────────────────────────┐
│  Docker Network: 172.20.0.0/24      │
│                                     │
│  ┌─────────────┐   ┌─────────────┐ │
│  │ INetSim     │   │ FakeNet-NG  │ │
│  │ 172.20.0.2  │   │ 172.20.0.3  │ │
│  │             │   │             │ │
│  │ • DNS       │   │ • HTTP      │ │
│  │ • SMTP      │   │ • HTTPS     │ │
│  │ • FTP       │   │ • Traffic   │ │
│  │ • Fallback  │   │   Analysis  │ │
│  └─────────────┘   └─────────────┘ │
│                                     │
│  ┌─────────────────────────────────┐│
│  │ Analyzer Container (Optional)   ││
│  └─────────────────────────────────┘│
└─────────────────────────────────────┘
        ↓ (Logging & Analysis)
┌─────────────────────────────────────┐
│  Logs & PCAP Data                   │
│  shared/logs/                       │
└─────────────────────────────────────┘
```

## Key Features

### ✅ Complete Network Isolation
- **Docker-based sandboxing** with custom network bridge
- **Static IP assignment** (172.20.0.0/24 subnet)
- **Host routing configuration** via iptables
- **No external communication** - all traffic contained

### ✅ INetSim Service Suite
- **DNS Server** (Port 53) - Wildcard DNS resolution
- **SMTP Service** (Port 25) - Email server simulation
- **FTP Service** (Port 21) - File transfer simulation
- **HTTP/HTTPS Fallback** (Ports 80, 443) - Basic web service

### ✅ FakeNet-NG Advanced Analysis
- **HTTP/HTTPS Interception** (Port 80, 443) - Advanced traffic analysis
- **Custom Response Injection** - API simulation, file serving
- **Traffic Capture** (PCAP format) - Network forensics
- **Behavioral Analysis** - C2 communication pattern detection

### ✅ Comprehensive Logging
- **Per-service logging** (INetSim, FakeNet-NG)
- **Traffic logs** (requests, responses, patterns)
- **PCAP capture** (for Wireshark analysis)
- **Centralized log storage** (shared/logs/)

### ✅ Port Conflict Resolution
- **No port mapping conflicts** - unique IPs for each service
- **Transparent traffic redirection** - iptables-based routing
- **Multi-port support** - alternative ports for each service

### ✅ Production-Ready
- **Docker Compose** simplifies deployment
- **Health checks** for service monitoring
- **Resource limits** to prevent runaway processes
- **Extensive documentation** and troubleshooting

## Quick Start

### Prerequisites
- Docker 20.10+
- Docker Compose 1.29+
- Linux OS (Ubuntu 20.04+ or CentOS 8+)
- 4 CPU cores, 8GB RAM minimum
- Root/sudo access for network configuration

### Installation (5 minutes)

```bash
# 1. Navigate to directory
cd integrated-malware-lab

# 2. Build and start containers
docker-compose up -d

# 3. Verify services
docker-compose ps

# 4. Configure host routing
chmod +x scripts/*.sh
sudo bash scripts/setup-routing.sh

# 5. Test connectivity
bash scripts/test-connectivity.sh

# 6. View logs
docker-compose logs -f
```

**That's it! Your lab is ready.**

## Usage Examples

### Basic: Test DNS Resolution

```bash
# Query DNS (should resolve to 172.20.0.2)
nslookup example.com

# From container
docker exec inetsim-server nslookup example.com 127.0.0.1
```

### Intermediate: Run Malware Sample

```bash
# Copy sample to container
docker cp malware.exe malware-analyzer:/samples/

# Execute inside container
docker exec malware-analyzer bash -c "cd /samples && strace -e trace=network ./malware.exe"

# View logs in real-time
tail -f shared/logs/inetsim/inetsim.log
tail -f shared/logs/fakenet-ng/fakenet-ng.log
```

### Advanced: Analyze Network Traffic

```bash
# View HTTP requests
grep "GET\|POST" shared/logs/fakenet-ng/traffic.log | head -20

# Analyze PCAP file
tcpdump -r shared/logs/fakenet-ng/traffic.pcap -n | head -10

#Export for Wireshark
scp shared/logs/fakenet-ng/traffic.pcap local-machine:~/
```

## File Structure

```
integrated-malware-lab/
├── docker-compose.yml              # Main orchestration config
├── README.md                        # This file
│
├── inetsim/                         # INetSim Service
│   ├── Dockerfile
│   ├── entrypoint.sh
│   └── config/
│       ├── inetsim.conf            # Service configuration
│       └── fakefile.conf           # Fake files mapping
│
├── fakenet-ng/                      # FakeNet-NG Service
│   ├── Dockerfile
│   ├── entrypoint.sh
│   ├── config/
│   │   ├── fakenet.conf            # Service configuration
│   │   └── responses_config.py      # Custom responses
│   └── certs/                       # SSL/TLS certificates
│
├── shared/
│   ├── logs/                        # Centralized logs
│   │   ├── inetsim/
│   │   └── fakenet-ng/
│   └── config/                      # Shared configuration
│
├── scripts/
│   ├── setup-routing.sh            # Configure host routing
│   ├── cleanup-routing.sh           # Remove routing rules
│   └── test-connectivity.sh         # Verify services
│
└── docs/
    ├── SETUP_GUIDE.md              # Installation guide
    ├── ARCHITECTURE.md              # Design documentation
    ├── TROUBLESHOOTING.md           # Problem solving
    └── README.md                    # This file
```

## Service Details

### INetSim (172.20.0.2)

**Primary Responsibilities:**
- **DNS Server** (53/UDP, TCP) - All DNS queries
- **SMTP** (25/TCP) - Email simulation
- **FTP** (21/TCP) - File transfer simulation
- **HTTP/HTTPS Fallback** (80, 443) - Unmatched web requests

**Configuration:** `inetsim/config/inetsim.conf`

### FakeNet-NG (172.20.0.3)

**Primary Responsibilities:**
- **HTTP/HTTPS Interception** (80, 443) - Primary web traffic
- **Advanced Analysis** - Request/response logging
- **Traffic Capture** - PCAP generation
- **Custom Responses** - API simulation, file serving

**Configuration:** `fakenet-ng/config/fakenet.conf`

## Network Configuration

### Docker Network
```
Subnet:     172.20.0.0/24
Gateway:    172.20.0.1
INetSim:    172.20.0.2
FakeNet-NG: 172.20.0.3
```

### Port Mapping (Host → Container)

**INetSim:**
- 53:53/UDP → DNS
- 25:25/TCP → SMTP
- 21:21/TCP → FTP
- 8080:80/TCP → HTTP fallback
- 8443:443/TCP → HTTPS fallback

**FakeNet-NG:**
- 80:80/TCP → HTTP
- 443:443/TCP → HTTPS
- 8000, 8080, 8888, 9000 → Alternative HTTP ports
- 8443 → Alternative HTTPS port

## Monitoring

### View Live Logs
```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f inetsim
docker-compose logs -f fakenet-ng

# Log files
tail -f shared/logs/inetsim/inetsim.log
tail -f shared/logs/fakenet-ng/traffic.log
```

### Container Stats
```bash
docker stats
```

### Network Traffic
```bash
# View intercepted HTTP requests
grep "GET\|POST\|PUT\|DELETE" shared/logs/fakenet-ng/traffic.log

# Analyze PCAP
tcpdump -r shared/logs/fakenet-ng/traffic.pcap -A | less
```

## Common Tasks

### Stop Services
```bash
docker-compose stop
```

### Restart Services
```bash
docker-compose restart

# Specific service
docker-compose restart inetsim
docker-compose restart fakenet-ng
```

### Clear Logs
```bash
rm -rf shared/logs/*
mkdir -p shared/logs/inetsim shared/logs/fakenet-ng
```

### Remove Everything
```bash
docker-compose down
docker network rm malware_lab
sudo bash scripts/cleanup-routing.sh
```

### Rebuild Images
```bash
docker-compose build --no-cache
docker-compose up -d
```

## Troubleshooting

### DNS Not Working
```bash
# Check INetSim is running
docker-compose ps | grep inetsim

# Test DNS from container
docker exec inetsim-server nslookup example.com 127.0.0.1

# Check routing rules
sudo iptables -t nat -L OUTPUT -n | grep 53

# See TROUBLESHOOTING.md for detailed solutions
```

### HTTP/HTTPS Not Intercepting
```bash
# Verify FakeNet-NG listening
docker exec fakenet-ng-server netstat -tlnup | grep -E "80|443"

# Test direct connection
curl http://172.20.0.3

# Check routing
sudo iptables -t nat -L OUTPUT -n | grep -E "80|443"

# See TROUBLESHOOTING.md for detailed solutions
```

### Performance Issues
```bash
# Check resource usage
docker stats

# Check log size
du -sh shared/logs/*

# Reduce logging verbosity
docker exec inetsim-server bash -c \
  'sed -i "s/log_level.*/log_level warning/" /etc/inetsim/inetsim.conf'
docker-compose restart inetsim
```

For more issues, see [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)

## Security Considerations

✅ **Network Isolation**
- Complete network separation via Docker bridge
- No external connectivity (internal: true)
- Firewall rules enforced on host

✅ **Access Control**
- Root access required for routing setup
- Container privileges minimized
- Read-only config volumes

✅ **Data Protection**
- Logs stored locally (can be encrypted)
- PCAP capture for forensic analysis
- Separate logs per malware sample possible

⚠️ **Risk Mitigation**
- Regular Docker/base image updates
- Resource limits prevent DoS
- Network monitoring enabled
- Audit logs maintained

## Advanced Configuration

### Enable Analyzer Container
Uncomment in `docker-compose.yml`:
```yaml
services:
  analyzer:
    image: ubuntu:22.04
    networks:
      malware_lab:
        ipv4_address: 172.20.0.10
    dns:
      - 172.20.0.2
    volumes:
      - ./samples:/samples
```

### Custom Response Handlers
Edit `fakenet-ng/config/responses_config.py` to add custom API responses, file serving, etc.

### Integration with SIEM
Ship logs to Splunk, ELK, or other SIEM:
- Logs stored in `shared/logs/`
- PCAP available in `shared/logs/fakenet-ng/traffic.pcap`
- Easy integration via log forwarding agents

## Documentation

- **[SETUP_GUIDE.md](docs/SETUP_GUIDE.md)** - Detailed installation & configuration
- **[ARCHITECTURE.md](docs/ARCHITECTURE.md)** - System design & data flow
- **[TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)** - Problem solving guide

## Support & Contributing

### Getting Help
1. Check [TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)
2. Review container logs: `docker-compose logs`
3. Run diagnostics: `bash scripts/test-connectivity.sh`
4. Check system resources: `docker stats`

### Known Issues
- Some malware may attempt to detect sandboxing
- High-volume malware samples may require resource tuning
- HTTPS interception requires custom cert installation on analyzer

## References

- **INetSim**: https://www.inetsim.org/
- **FakeNet-NG**: https://github.com/countercept/fakenet-ng
- **Docker**: https://docs.docker.com/
- **Malware Analysis**: https://www.sans.org/white-papers/

## License

This project integrates open-source components:
- INetSim - GNU GPL v2
- FakeNet-NG - MIT License
- Docker & Docker Compose - Apache 2.0

See individual components for license details.

## Version Info

- **Version**: 1.0
- **Created**: February 2026
- **Status**: Production Ready
- **Maintainer**: DevSecOps Team

---

**Last Updated**: February 2026  
**Next Review**: June 2026  
**Maintained by**: DevSecOps - Malware Analysis Lab Team
