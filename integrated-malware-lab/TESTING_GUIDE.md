# Testing Guide - Complete Test Scenarios

## üìå Overview
H∆∞·ªõng d·∫´n chi ti·∫øt ƒë·ªÉ test t·ª´ng th√†nh ph·∫ßn v√† to√†n b·ªô h·ªá th·ªëng.

---

## üéØ Test Levels

### Level 1: Pre-Deployment Tests
- Docker images build ‚úì
- Configuration syntax ‚úì
- File structure ‚úì
- Port availability ‚úì

### Level 2: Container Tests
- Container startup ‚úì
- Service initialization ‚úì
- Health checks ‚úì
- Log generation ‚úì

### Level 3: Service Tests
- DNS resolution ‚úì
- HTTP interception ‚úì
- HTTPS interception ‚úì
- SMTP/FTP services ‚úì

### Level 4: Integration Tests
- Traffic flow ‚úì
- Logging correlation ‚úì
- Performance metrics ‚úì
- Error recovery ‚úì

### Level 5: Advanced Tests
- Stress testing ‚úì
- Network simulation ‚úì
- Malware analysis scenarios ‚úì
- Concurrent requests ‚úì

---

## ‚ö° Quick Start Test (5 minutes)

```bash
cd integrated-malware-lab

# 1. Check prerequisites
bash scripts/test-connectivity.sh --quick

# 2. Start system
docker-compose up -d

# 3. Wait for containers
sleep 10

# 4. Quick test
nslookup example.com
curl http://localhost:8080

# 5. View logs
docker-compose logs
```

**Expected Output:**
```
‚úì DNS query ‚Üí 172.20.0.2
‚úì HTTP response ‚Üí FakeNet-NG
‚úì Containers running
‚úì No errors in logs
```

---

## üìã Pre-Deployment Tests

### 1Ô∏è‚É£ Check Prerequisites

```bash
# Check Docker
docker --version
docker-compose --version

# Expected: Docker 20.10+, Docker Compose 1.29+
```

### 2Ô∏è‚É£ Check Port Availability

```bash
# Run the test script
bash scripts/test-connectivity.sh --ports

# Manually check specific ports
netstat -tlnp | grep -E '(53|25|21|8080|8443|80|443)'

# On Windows PowerShell
Get-NetTCPConnection | Where-Object {$_.LocalPort -in 53, 25, 21, 8080, 8443}
```

**Expected:** All ports free (can be used)

### 3Ô∏è‚É£ Verify Configuration Files

```bash
# Check YAML syntax
python3 -c "import yaml; yaml.safe_load(open('docker-compose.yml'))"

# Check Python syntax
python3 -m py_compile fakenet-ng/config/responses_config.py

# Check Bash scripts
bash -n scripts/setup-routing.sh
bash -n scripts/cleanup-routing.sh
bash -n scripts/test-connectivity.sh

# Check INI files
grep -v '^#' inetsim/config/inetsim.conf | grep -v '^$'
```

**Expected:** No errors

### 4Ô∏è‚É£ File Structure Verification

```bash
# Check all critical files exist
REQUIRED_FILES=(
    "docker-compose.yml"
    "inetsim/Dockerfile"
    "inetsim/entrypoint.sh"
    "inetsim/config/inetsim.conf"
    "inetsim/config/fakefile.conf"
    "fakenet-ng/Dockerfile"
    "fakenet-ng/entrypoint.sh"
    "fakenet-ng/config/fakenet.conf"
    "fakenet-ng/config/responses_config.py"
    "scripts/setup-routing.sh"
    "scripts/cleanup-routing.sh"
    "scripts/test-connectivity.sh"
)

for file in "${REQUIRED_FILES[@]}"; do
    if [ -f "$file" ]; then
        echo "‚úì $file"
    else
        echo "‚úó $file MISSING"
    fi
done
```

---

## üê≥ Container Tests

### 1Ô∏è‚É£ Build Docker Images

```bash
# Build both images
docker-compose build

# Or build individually
docker-compose build inetsim
docker-compose build fakenet-ng

# Check images
docker images | grep -E "(inetsim|fakenet)"
```

**Expected Output:**
```
inetsim                    latest    abc123def   2 hours ago   500MB
fakenet-ng                 latest    xyz789abc   2 hours ago   400MB
```

### 2Ô∏è‚É£ Start Containers

```bash
# Start in background
docker-compose up -d

# Wait for startup
sleep 15

# Check status
docker-compose ps
```

**Expected Output:**
```
CONTAINER ID   IMAGE           STATUS                     PORTS
abc123         inetsim:latest  Up 10s (healthy)          0.0.0.0:53->53/udp, ...
xyz789         fakenet:latest  Up 8s (health: starting)  0.0.0.0:8080->80/tcp, ...
```

### 3Ô∏è‚É£ Check Container Logs

```bash
# INetSim logs
docker-compose logs inetsim

# FakeNet-NG logs
docker-compose logs fakenet-ng

# Follow logs in real-time
docker-compose logs -f

# Or using Docker
docker logs inetsim-server
docker logs fakenet-ng
```

**Expected Output:**
```
inetsim-server    | [2024-01-15 10:30:45] INetSim started
inetsim-server    | [2024-01-15 10:30:45] DNS listening on 0.0.0.0:53
fakenet-ng        | [2024-01-15 10:30:46] FakeNet-NG initialized
fakenet-ng        | [2024-01-15 10:30:46] HTTP listener on 0.0.0.0:80
```

### 4Ô∏è‚É£ Verify Health Checks

```bash
# Check via docker-compose
docker-compose ps

# Or via Docker directly
docker exec inetsim-server nc -u -z 127.0.0.1 53 && echo "‚úì INetSim healthy"
docker exec fakenet-ng curl -s http://127.0.0.1:80 > /dev/null && echo "‚úì FakeNet-NG healthy"

# Check container inspect
docker inspect inetsim-server --format='{{.State.Health.Status}}'
docker inspect fakenet-ng --format='{{.State.Health.Status}}'
```

**Expected:**
```
‚úì INetSim healthy
‚úì FakeNet-NG healthy
healthy
healthy
```

### 5Ô∏è‚É£ Verify Network

```bash
# Check custom network
docker network ls | grep malware_lab

# Inspect network
docker network inspect integrated-malware-lab_malware_lab

# Check container IPs
docker inspect inetsim-server    --format='{{.NetworkSettings.Networks.integrated-malware-lab_malware_lab.IPAddress}}'
docker inspect fakenet-ng         --format='{{.NetworkSettings.Networks.integrated-malware-lab_malware_lab.IPAddress}}'
```

**Expected:**
```
172.20.0.2   (INetSim)
172.20.0.3   (FakeNet-NG)
```

---

## üåê Service Tests

### 1Ô∏è‚É£ DNS Testing

```bash
# Test DNS from host
nslookup example.com localhost:53
nslookup google.com localhost:53

# Or with dig
dig example.com @localhost

# Or with drill
drill example.com @localhost:53

# Test from container
docker-compose exec inetsim nslookup example.com 127.0.0.1
docker-compose exec fakenet-ng nslookup example.com 172.20.0.2
```

**Expected Output:**
```
Server:         127.0.0.1
Address:        127.0.0.1#53

Non-authoritative answer:
Name:           example.com
Address:        172.20.0.2
```

**Test Cases:**
```bash
# Test wildcard
nslookup random.domain.test localhost:53

# Test deep subdomain
nslookup sub.domain.example.com localhost:53

# Test reverse lookup (optional)
nslookup 172.20.0.2 localhost:53
```

### 2Ô∏è‚É£ HTTP Testing

```bash
# Basic HTTP test
curl -v http://localhost:8080

# With Host header manipulation
curl -v -H "Host: custom.domain.com" http://localhost:8080

# Test specific paths
curl -v http://localhost:8080/test
curl -v http://localhost:8080/malware.exe
curl -v http://localhost:8080/script.js

# Check response headers
curl -I http://localhost:8080

# Get response body
curl -s http://localhost:8080 | head -20
```

**Expected Output:**
```
HTTP/1.1 200 OK
Server: Microsoft-IIS/10.0
Content-Type: text/html
Content-Length: 45

<html>FakeNet-NG Response</html>
```

### 3Ô∏è‚É£ HTTPS Testing

```bash
# Ignore certificate errors
curl -k https://localhost:8443

# With verbose output
curl -k -v https://localhost:8443

# Check certificate
openssl s_client -connect localhost:8443 -showcerts
```

**Expected:** HTTPS connection succeeds (with cert warning)

### 4Ô∏è‚É£ SMTP Testing

```bash
# Check SMTP port
nc -zv localhost 25

# Or with timeout
timeout 2 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/25' && echo "‚úì SMTP open"

# Connect and send email
{
  echo "EHLO test.local"
  echo "MAIL FROM:<from@test.com>"
  echo "RCPT TO:<to@test.com>"
  echo "DATA"
  echo "Subject: Test"
  echo ""
  echo "Test message"
  echo "."
  echo "QUIT"
} | nc localhost 25
```

**Expected:**
```
220 inetsim-server ESMTP
250 OK
250 OK
250 OK
354 OK
250 OK
221 Bye
```

### 5Ô∏è‚É£ FTP Testing

```bash
# Check FTP port
nc -zv localhost 21

# Connect via FTP
ftp localhost 21

# Or with script
{
  echo "admin"      # Default username
  echo "admin"      # Default password
  echo "LIST"
  echo "RETR fakefile.conf"
  echo "QUIT"
} | ftp localhost 21
```

**Expected:**
```
220 inetsim-server FTP
331 OK
230 OK
200 OK
150 OK
226 OK
221 Bye
```

---

## üìä Integration Tests

### 1Ô∏è‚É£ Complete DNS ‚Üí INetSim ‚Üí FakeNet Flow

```bash
# Test sequence
echo "Testing: DNS ‚Üí INetSim ‚Üí FakeNet"

# Step 1: Query DNS (INetSim)
echo "1. DNS Query:"
nslookup malware.test localhost:53 | grep "Address"

# Step 2: Connect to returned IP (FakeNet)
IP=$(dig +short malware.test @localhost)
echo "2. Connect to IP $IP:"
curl -v http://$IP:8080

# Step 3: Check logs
echo "3. INetSim logs:"
docker-compose logs inetsim | tail -5

echo "4. FakeNet-NG logs:"
docker-compose logs fakenet-ng | tail -5
```

### 2Ô∏è‚É£ Logging Correlation

```bash
# Simulate malware beaconing
echo "Simulating malware behavior..."

# Request 1: DNS lookup
nslookup c2.server localhost:53

# Request 2: HTTP connection
curl -s -H "User-Agent: Malware/1.0" http://localhost:8080/update

# Request 3: File download
curl -s http://localhost:8080/payload.exe -o /tmp/payload.exe

# Check correlated logs
echo "INetSim DNS log:"
grep "c2.server" shared/logs/inetsim/inetsim.log | tail -3

echo "FakeNet-NG HTTP log:"
grep "update\|payload" shared/logs/fakenet-ng/*.log | tail -3
```

### 3Ô∏è‚É£ Service Health Monitoring

```bash
# Continuous health check
for i in {1..10}; do
    echo "Check $i at $(date '+%H:%M:%S'):"
    docker-compose ps | grep -E "inetsim|fakenet" | awk '{print $NF}'
    sleep 5
done
```

**Expected:** Always "healthy" or "Up (health: starting)"

---

## ‚öôÔ∏è Advanced Tests

### 1Ô∏è‚É£ Stress Testing - DNS

```bash
# Generate DNS traffic
for i in {1..1000}; do
    dig test$i.example.com @localhost +short
done &

# Monitor
watch -n 1 'docker stats --no-stream | grep -E "inetsim|fakenet"'

# Kill test
pkill -f "dig test"
```

### 2Ô∏è‚É£ Stress Testing - HTTP

```bash
# Using Apache Bench (ab)
ab -n 100 -c 10 http://localhost:8080/

# Using curl loop
for i in {1..100}; do
    curl -s http://localhost:8080 > /dev/null &
done
wait

# Using Python requests
python3 << 'EOF'
import requests
from concurrent.futures import ThreadPoolExecutor

def fetch():
    requests.get('http://localhost:8080')

with ThreadPoolExecutor(max_workers=10) as executor:
    [executor.submit(fetch) for _ in range(100)]
EOF
```

### 3Ô∏è‚É£ Resource Monitoring

```bash
# Real-time resource usage
docker stats --no-stream

# Memory usage
docker exec inetsim-server ps aux | grep inetsim
docker exec fakenet-ng ps aux | grep fakenet

# Disk usage
du -sh shared/logs/inetsim
du -sh shared/logs/fakenet-ng

# Network connections
netstat -tlnp | grep -E "53|25|21|8080|8443"
```

### 4Ô∏è‚É£ Performance Benchmarking

```bash
# DNS response time
time nslookup example.com localhost:53

# HTTP response time
time curl -s http://localhost:8080 > /dev/null

# Concurrent DNS queries
time pssh -h hosts.txt -i "nslookup example.com localhost:53"
```

### 5Ô∏è‚É£ Traffic Capture & Analysis

```bash
# Capture HTTP traffic
docker-compose exec fakenet-ng tcpdump -i any -w /var/log/fakenet-ng/capture.pcap tcp port 80

# In another terminal - Generate traffic
curl http://localhost:8080

# Stop capture (Ctrl+C)

# Analyze PCAP in another way
docker-compose exec fakenet-ng tshark -r /var/log/fakenet-ng/capture.pcap

# Download and analyze locally
docker cp fakenet-ng:/var/log/fakenet-ng/capture.pcap ./traffic.pcap
wireshark traffic.pcap  # On your machine
```

---

## üîç Troubleshooting Tests

### 1Ô∏è‚É£ Container Won't Start

```bash
# Check logs
docker-compose logs inetsim

# Check config
docker-compose exec inetsim cat /etc/inetsim/inetsim.conf

# Test syntax
docker-compose exec inetsim bash -x /entrypoint.sh
```

### 2Ô∏è‚É£ DNS Not Responding

```bash
# Inside container
docker-compose exec inetsim nslookup example.com 127.0.0.1

# Check process
docker-compose exec inetsim ps aux | grep inetsim

# Check listening ports
docker-compose exec inetsim netstat -tlnup | grep 53
```

### 3Ô∏è‚É£ HTTP Not Working

```bash
# Test with curl
curl -v http://localhost:8080

# From container
docker-compose exec fakenet-ng curl -v http://127.0.0.1

# Check FakeNet process
docker-compose exec fakenet-ng ps aux | grep fakenet
```

---

## üìà Test Results Template

Create `TESTING_RESULTS.md`:

```markdown
# Testing Results - [DATE]

## Pre-Deployment Tests
- [ ] Docker version ‚úì
- [ ] Docker Compose version ‚úì
- [ ] Port availability ‚úì
- [ ] Config syntax ‚úì

## Container Tests
- [ ] Build successful ‚úì
- [ ] Containers start ‚úì
- [ ] Health checks pass ‚úì
- [ ] Network created ‚úì
- [ ] IPs assigned correctly ‚úì

## Service Tests
- [ ] DNS works ‚úì
- [ ] HTTP works ‚úì
- [ ] HTTPS works ‚úì
- [ ] SMTP works ‚úì
- [ ] FTP works ‚úì

## Integration Tests
- [ ] DNS ‚Üí INetSim flow ‚úì
- [ ] HTTP ‚Üí FakeNet flow ‚úì
- [ ] Logging works ‚úì
- [ ] Performance OK ‚úì

## Issues Found
- None ‚úì

## Summary
System is production-ready ‚úì
```

---

## üöÄ Full Test Suite (Automated)

```bash
#!/bin/bash
# run-full-tests.sh

set -e
RESULTS="TESTING_RESULTS.txt"

echo "=== FULL TEST SUITE ===" | tee "$RESULTS"

echo "1. Pre-deployment tests..." | tee -a "$RESULTS"
bash scripts/test-connectivity.sh --quick >> "$RESULTS" 2>&1 || true

echo "2. Starting containers..." | tee -a "$RESULTS"
docker-compose up -d

echo "3. Waiting for startup..." | tee -a "$RESULTS"
sleep 15

echo "4. Container tests..." | tee -a "$RESULTS"
docker-compose ps >> "$RESULTS"

echo "5. DNS tests..." | tee -a "$RESULTS"
nslookup example.com localhost:53 >> "$RESULTS" 2>&1 || true

echo "6. HTTP tests..." | tee -a "$RESULTS"
curl -s http://localhost:8080 >> "$RESULTS" 2>&1 || true

echo "7. HTTPS tests..." | tee -a "$RESULTS"
curl -k -s https://localhost:8443 >> "$RESULTS" 2>&1 || true

echo "8. Log verification..." | tee -a "$RESULTS"
echo "INetSim logs:" >> "$RESULTS"
docker-compose logs inetsim | tail -10 >> "$RESULTS"
echo "FakeNet logs:" >> "$RESULTS"
docker-compose logs fakenet-ng | tail -10 >> "$RESULTS"

echo "=== TESTS COMPLETE ===" | tee -a "$RESULTS"
cat "$RESULTS"
```

Run it:
```bash
bash run-full-tests.sh
```

---

## ‚úÖ Success Criteria

| Test | Status | Expected |
|------|--------|----------|
| Containers Start | ‚úì | Both running |
| Health Checks | ‚úì | Healthy |
| DNS Resolution | ‚úì | 172.20.0.2 |
| HTTP Response | ‚úì | 200 OK |
| HTTPS Response | ‚úì | 200 OK |
| Logs Generated | ‚úì | Entries visible |
| Memory Usage | ‚úì | < 1GB total |
| CPU Usage | ‚úì | < 50% average |

**All tests passing ‚Üí System is ready for use** ‚úì

---

**Next:** See [QUICKSTART_5MIN.md](QUICKSTART_5MIN.md) for rapid deployment.
