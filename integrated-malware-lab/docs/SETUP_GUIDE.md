# Hướng Dẫn Cấu Hình & Triển Khai Integrated Malware Analysis Lab

## Tổng Quan

Integrated Malware Analysis Lab là một giải pháp toàn diện cho phân tích mã độc đảm bảo an toàn với sự tích hợp của:
- **INetSim**: DNS Server + Dịch vụ cơ bản (SMTP, FTP, HTTP/HTTPS fallback)
- **FakeNet-NG**: Advanced HTTP/HTTPS Traffic Interception & Analysis

### Kiến Trúc:
```
┌─────────────────────────────────────────────────────────────┐
│                      HOST MACHINE                           │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Docker Network: 172.20.0.0/24 (malware_lab)       │  │
│  │                                                     │  │
│  │  ┌─────────────────┐      ┌──────────────────┐    │  │
│  │  │  INetSim        │      │  FakeNet-NG      │    │  │
│  │  │  172.20.0.2     │      │  172.20.0.3      │    │  │
│  │  │                 │      │                  │    │  │
│  │  │ DNS: 53         │      │ HTTP: 80         │    │  │
│  │  │ SMTP: 25        │      │ HTTPS: 443       │    │  │
│  │  │ FTP: 21         │      │                  │    │  │
│  │  │ HTTP: 80        │      │ Advanced Traffic │    │  │
│  │  │ HTTPS: 443      │      │ Analysis         │    │  │
│  │  └─────────────────┘      └──────────────────┘    │  │
│  │                                                     │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Malware Analyzer Container (Optional)              │  │
│  │  Chạy malware samples trong sandbox                │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Host Routing Configuration (iptables)             │  │
│  │  - DNS: Redirect tới INetSim                       │  │
│  │  - HTTP/HTTPS: Redirect tới FakeNet-NG            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Yêu Cầu Hệ Thống

### Hardware:
- **CPU**: Tối thiểu 4 cores (8 cores khuyến nghị)
- **RAM**: 8GB tối thiểu (16GB khuyến nghị)
- **Disk**: 50GB + (cho logs và samples)

### Software:
- **Docker**: >= 20.10
- **Docker Compose**: >= 1.29
- **Linux OS**: Ubuntu 20.04+ hoặc CentOS 8+
- **iptables**: phải được cài đặt (để cấu hình routing)
- **Root/sudo access**: cần để cấu hình networking

### Ports Cần Có Sẵn:
- 53/UDP (DNS)
- 25/TCP (SMTP)
- 21/TCP (FTP)
- 80/TCP (HTTP)
- 443/TCP (HTTPS)
- 8080, 8443, 8000, 8888, 9000/TCP (Alternative ports)

## Cài Đặt & Triển Khai

### Bước 1: Chuẩn Bị Môi Trường

```bash
# Clone repository hoặc navigate tới folder integrated-malware-lab
cd integrated-malware-lab

# Tạo shared directories cho logs
mkdir -p shared/logs/inetsim shared/logs/fakenet-ng
mkdir -p shared/config

# Set permissions
chmod -R 777 shared/logs shared/config
```

### Bước 2: Cấu Hình Files

Các file cấu hình đã có sẵn:
- `inetsim/config/inetsim.conf` - INetSim configuration
- `inetsim/config/fakefile.conf` - Fake files configuration
- `fakenet-ng/config/fakenet.conf` - FakeNet-NG configuration
- `fakenet-ng/config/responses_config.py` - Custom responses

**Tuỳ chỉnh nếu cần:**

```bash
# Edit INetSim configuration
nano inetsim/config/inetsim.conf

# Edit FakeNet-NG configuration
nano fakenet-ng/config/fakenet.conf
```

### Bước 3: Build Docker Images

```bash
# Build containers từ Dockerfile
docker-compose build --no-cache

# Or pull pre-built images nếu có
# docker-compose pull
```

### Bước 4: Start Containers

```bash
# Khởi chạy services
docker-compose up -d

# Kiểm tra status
docker-compose ps

# View logs
docker-compose logs -f
```

### Bước 5: Cấu Hình Host Network Routing

**⚠️ ALERT: Cần root/sudo privileges**

```bash
# Make scripts executable
chmod +x scripts/*.sh

# Cấu hình routing rules trên host
sudo bash scripts/setup-routing.sh

# Verify routing configuration
sudo iptables -t nat -L -n -v
```

### Bước 6: Kiểm Tra Kết Nối

```bash
# Test connectivity (có thể chạy với user thường)
bash scripts/test-connectivity.sh

# Test DNS resolution manually
nslookup example.com

# Test HTTP connectivity
curl http://example.com

# View container logs
docker-compose logs inetsim
docker-compose logs fakenet-ng
```

## Chi Tiết Cấu Hình

### INetSim - DNS Server & Basic Services

**Port Mapping:**
- 53/UDP, 53/TCP: DNS (Primary service)
- 25/TCP: SMTP Email simulation
- 21/TCP: FTP File transfer simulation
- 80/TCP: HTTP Fallback
- 443/TCP: HTTPS Fallback

**IP Address:** 172.20.0.2

**Cấu hình chính (`inetsim.conf`):**
```ini
service_binds 0.0.0.0:53      # DNS
service_binds 0.0.0.0:25      # SMTP
service_binds 0.0.0.0:21      # FTP
service_binds 0.0.0.0:80      # HTTP
service_binds 0.0.0.0:443     # HTTPS

dns_default_ip 172.20.0.2
dns_bind_redirect_enable 1    # Catch all DNS queries

log_level debug
```

**Log Files:**
```
shared/logs/inetsim/inetsim.log        # Main log
shared/logs/inetsim/inetsim.stat       # Statistics
```

### FakeNet-NG - Advanced HTTP/HTTPS Analysis

**Port Mapping:**
- 80/TCP: HTTP (Primary)
- 443/TCP: HTTPS (Primary)
- 8000, 8080, 8443, 8888, 9000/TCP: Alternative ports

**IP Address:** 172.20.0.3

**Cấu hình chính (`fakenet.conf`):**
```ini
[HTTPListener]
Port = 80
AlternativePorts = 8000, 8080, 8888, 9000

[HTTPSListener]
Port = 443
AlternativePorts = 8443

[Advanced]
HTPCompatibility = True
ForwardToINetSim = True
INetSimIP = 172.20.0.2
INetSimPort = 80
```

**Response Handlers (`responses_config.py`):**
- JSON responses cho APIs
- Binary files (EXE, ZIP, etc.)
- HTML, PDF, Images, etc.
- Custom headers (Server: Microsoft-IIS/10.0)

**Log Files:**
```
shared/logs/fakenet-ng/fakenet-ng.log   # Main log
shared/logs/fakenet-ng/traffic.log      # Traffic details
shared/logs/fakenet-ng/traffic.pcap     # Packet capture
```

### Host Network Routing

Cấu hình routing trên host machine để redirect malware traffic:

```bash
# DNS redirection (53/UDP → INetSim)
iptables -t nat -A OUTPUT -p udp --dport 53 -j DNAT --to 172.20.0.2:53

# HTTP redirection (80/TCP → FakeNet-NG)
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to 172.20.0.3:80

# HTTPS redirection (443/TCP → FakeNet-NG)
iptables -t nat -A OUTPUT -p tcp --dport 443 -j DNAT --to 172.20.0.3:443

# SMTP redirection (25/TCP → INetSim)
iptables -t nat -A OUTPUT -p tcp --dport 25 -j DNAT --to 172.20.0.2:25

# FTP redirection (21/TCP → INetSim)
iptables -t nat -A OUTPUT -p tcp --dport 21 -j DNAT --to 172.20.0.2:21
```

**Saved Rules:** `scripts/iptables.rules`

## Phân Chia Nhiệm Vụ (Task Separation)

### INetSim Responsibilities:
1. **DNS Resolution** (Primary)
   - Responds to all DNS queries
   - Redirects to 172.20.0.2 for all domains
   - TTL: 3600 seconds

2. **Basic Services**
   - SMTP: Email server simulation
   - FTP: File transfer simulation
   - HTTP/HTTPS: Fallback for non-intercepted requests

3. **File Serving**
   - Serves fake EXE, ZIP, PDF files
   - Configurable responses via `fakefile.conf`

### FakeNet-NG Responsibilities:
1. **HTTP/HTTPS Interception** (Primary)
   - Intercepts all HTTP (80) requests
   - Intercepts all HTTPS (443) requests
   - Analyzes traffic patterns

2. **Advanced Response Handling**
   - Custom JSON responses for APIs
   - Binary file serving
   - Multi-format support
   - SSL/TLS interception

3. **Traffic Analysis**
   - Packet capture (PCAP format)
   - Request/response logging
   - Behavioral analysis

## Xử Lý Port Conflicts

### Vấn Đề:
Cả INetSim và FakeNet-NG đều cần binding tới các ports chuẩn (80, 443, 53, etc.)

### Giải Pháp:

#### 1. **Static IP Assignment (Implemented)**
```yaml
# docker-compose.yml
networks:
  malware_lab:
    ipv4_address: 172.20.0.2  # INetSim
    ipv4_address: 172.20.0.3  # FakeNet-NG
```

**Lợi ích:**
- Mỗi container có IP riêng
- Có thể bind cùng port trên các IP khác nhau
- Subnet riêng biệt (172.20.0.0/24)

#### 2. **iptables Traffic Redirection**
```bash
# Host routing rules
iptables -t nat -A OUTPUT -p tcp --dport 80 -j DNAT --to 172.20.0.3:80
```

**Lợi ích:**
- Traffic từ host được redirect tự động
- Malware samples không cần config đặc biệt
- Transparent to the analysis target

#### 3. **Port Priority Distribution**
```
INetSim (172.20.0.2):      FakeNet-NG (172.20.0.3):
- 53/UDP (DNS)             - 80/TCP (HTTP)
- 25/TCP (SMTP)            - 443/TCP (HTTPS)
- 21/TCP (FTP)             - 8000/TCP (Alt HTTP)
- 8080/TCP (Fallback HTTP) - 8080/TCP (Alt HTTP)
- 8443/TCP (Fallback HTTPS)- 8443/TCP (Alt HTTPS)
```

## Monitoring & Logs

### Real-time Monitoring

```bash
# View container logs (all services)
docker-compose logs -f

# View specific service logs
docker-compose logs -f inetsim
docker-compose logs -f fakenet-ng

# Follow specific log files
tail -f shared/logs/inetsim/inetsim.log
tail -f shared/logs/fakenet-ng/fakenet-ng.log
```

### Log Analysis

```bash
# Count DNS queries per domain
grep "DNS query" shared/logs/inetsim/inetsim.log | awk '{print $NF}' | sort | uniq -c | sort -rn

# List all HTTP requests intercepted
grep "GET\|POST" shared/logs/fakenet-ng/traffic.log | head -20

# Analyze PCAP file
tcpdump -r shared/logs/fakenet-ng/traffic.pcap -n | head -10

# Get statistics
docker-compose logs inetsim | grep -i "statistics"
```

### Metrics & Performance

```bash
# Docker container stats
docker stats

# Network interface stats
docker exec inetsim-server ip -s link

# DNS query statistics
docker exec inetsim-server cat /var/log/inetsim/inetsim.stat
```

## Troubleshooting

### Issue 1: Port Already in Use

**Symptoms:** `Error response from daemon: Bind for 0.0.0.0:53 failed: port is already allocated`

**Solutions:**
```bash
# Kiểm tra port nào đang dùng
lsof -i :53

# Dừng service đang chiếm port
sudo systemctl stop systemd-resolved

# Hoặc chỉnh sửa docker-compose.yml để map port khác
ports:
  - "5353:53/udp"  # Map 5353 on host → 53 in container
```

### Issue 2: DNS Not Resolving (Host)

**Symptoms:** `nslookup: can't resolve`

**Solutions:**
```bash
# Verify routing rules
sudo iptables -t nat -L OUTPUT -n | grep 53

# Reapply routing
sudo bash scripts/setup-routing.sh

# Test DNS from container
docker exec inetsim-server nslookup example.com 127.0.0.1
```

### Issue 3: HTTP/HTTPS Not Intercepting

**Symptoms:** Requests không được malware ghi log

**Solutions:**
```bash
# Check FakeNet-NG service
docker-compose logs fakenet-ng | grep -i "error|listening"

# Verify container listening on ports
docker exec fakenet-ng-server netstat -tlnp | grep -E "80|443"

# Check firewall rules
sudo iptables -t nat -L OUTPUT -n | grep -E "80|443"
```

### Issue 4: Container Exit/Crash

**Symptoms:** `Exited (1) 5 seconds ago`

**Solutions:**
```bash
# Check container logs
docker-compose logs --tail=50 inetsim

# Rebuild container
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# Check system resources
docker stats
free -h
df -h
```

## Advanced Usage

### Running Malware Samples

#### Method 1: Sử dụng Analyzer Container (Recommended)

```bash
# Uncomment analyzer section trong docker-compose.yml
# Khởi chạy analyzer container
docker-compose up -d analyzer

# Copy sample vào container
docker cp malware.exe analyzer:/samples/

# Execute trong container
docker exec analyzer bash -c "cd /samples && ./malware.exe"

# View logs
docker-compose logs analyzer
docker logs inetsim-server | grep "malware\|example.com"
```

#### Method 2: Direct Execution (Host)

```bash
# Setup environment
export LD_LIBRARY_PATH=/opt/fakenet-ng/lib:$LD_LIBRARY_PATH

# Run malware (with caution!)
./malware.exe

# Monitor from another terminal
tail -f shared/logs/inetsim/inetsim.log
```

### Custom Response Injection

Modify `fakenet-ng/config/responses_config.py`:

```python
# Add custom handler
'malware_c2': {
    'pattern': r'.*api\.malware\.c2.*',
    'content': '{"status": "compromised", "payload": ""}',
    'content_type': 'application/json'
}
```

Then reload FakeNet-NG:
```bash
docker-compose restart fakenet-ng
```

### Dynamic Configuration Updates

```bash
# Update INetSim config (live)
docker exec inetsim-server bash -c 'echo "dns_default_ttl 1800" >> /etc/inetsim/inetsim.conf'
docker-compose restart inetsim

# Update FakeNet-NG responses
docker cp new_responses_config.py fakenet-ng-server:/opt/fakenet-ng/
docker-compose restart fakenet-ng
```

## Data Retention & Analysis

### Backup Logs

```bash
# Archive current logs
tar -czf malware-analysis-$(date +%Y%m%d-%H%M%S).tar.gz shared/logs/

# Move to analysis server
scp malware-analysis-*.tar.gz analysis-server:/archive/
```

### Export PCAP for External Analysis

```bash
# Copy PCAP file
cp shared/logs/fakenet-ng/traffic.pcap ./traffic.pcap

# Analyze with Wireshark
wireshark traffic.pcap

# Or analyze via tcpdump
tcpdump -r traffic.pcap -A 'tcp[tcpflags] & tcp-syn != 0'
```

### Central Logging (Optional)

```bash
# Ship logs to ELK stack, Splunk, etc.
docker run -d \
  -e ELASTICSEARCH_URL=http://elasticsearch:9200 \
  -v ./shared/logs:/logs \
  filebeat
```

## Cleanup & Shutdown

```bash
# Stop containers gracefully
docker-compose stop

# Remove containers
docker-compose rm

# Remove network
docker network rm malware_lab

# Clean up routing (on host)
sudo bash scripts/cleanup-routing.sh

# Remove all data
docker system prune -a --volumes
```

## Security Best Practices

1. **Network Isolation**
   - Keep lab network separate from production
   - Use firewall rules to restrict inter-container traffic
   - Monitor all traffic for anomalies

2. **Access Control**
   - Limit who can access the lab environment
   - Use strong authentication if exporting logs
   - Audit access logs regularly

3. **Sample Management**
   - Store samples in encrypted volume
   - Track sample provenance
   - Implement quota limits
   - Regular cleanup of old samples

4. **Resource Limits**
   - Set CPU/Memory limits per container
   - Monitor disk usage (logs can grow large)
   - Implement log rotation

5. **Updates**
   - Keep Docker and base images updated
   - Monitor for security patches
   - Test updates in dev environment first

## References

- [INetSim Documentation](https://www.inetsim.org/)
- [FakeNet-NG GitHub](https://github.com/countercept/fakenet-ng)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Malware Analysis Lab Best Practices](https://www.sans.org/)

## Support & Troubleshooting

For detailed troubleshooting and support, see: [TROUBLESHOOTING.md](TROUBLESHOOTING.md)

---
**Last Updated:** February 2026
**Version:** 1.0
**Status:** Production Ready
