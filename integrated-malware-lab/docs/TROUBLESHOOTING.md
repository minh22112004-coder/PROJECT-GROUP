# Troubleshooting Guide - Integrated Malware Analysis Lab

## Quick Diagnostics

### 1. Check System Status

```bash
# General Docker status
docker-compose ps
docker-compose logs

# Individual service status
docker ps | grep -E "inetsim|fakenet"
docker inspect inetsim-server
docker inspect fakenet-ng-server

# Network status
docker network ls
docker network inspect malware_lab

# Host routing status
sudo iptables -t nat -L OUTPUT -n
ip route show
```

### 2. Service Health Checks

```bash
# INetSim container
docker exec inetsim-server ps aux | grep inetsim
docker exec inetsim-server nc -u -z 127.0.0.1 53
docker exec inetsim-server ls -la /var/log/inetsim/

# FakeNet-NG container
docker exec fakenet-ng-server ps aux | grep fakenet
docker exec fakenet-ng-server nc -z 127.0.0.1 80
docker exec fakenet-ng-server ls -la /var/log/fakenet-ng/
```

---

## Common Issues & Solutions

### Issue 1: Containers Won't Start

#### Symptoms:
- `docker-compose up` fails
- `Exited (1) few seconds ago`
- `Error: failed to create network`

#### Diagnosis:

```bash
# Check detailed error logs
docker-compose logs --tail=100

# Check image availability
docker images | grep -E "inetsim|fakenet"

# Check system resources
docker stats
free -h
df -h
```

#### Solutions:

**A) Docker daemon not running**
```bash
# Linux
sudo systemctl start docker

# MacOS
open /Applications/Docker.app

# Verify
docker version
```

**B) Insufficient disk space**
```bash
# Check disk usage
df -h /var/lib/docker

# Clean up old images
docker system prune -a

# Increase Docker disk allocation (Docker Desktop)
# Settings > Resources > Disk Image Size
```

**C) Network already exists**
```bash
# Remove old network
docker network rm malware_lab

# Retry docker-compose
docker-compose down
docker-compose up -d
```

**D) Port already in use**
```bash
# Find process using port
sudo lsof -i :53
sudo lsof -i :80
sudo lsof -i :443

# Kill process (example: systemd-resolved on 53)
sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved

# Try alternate ports in docker-compose.yml
ports:
  - "5353:53/udp"
  - "8888:80"
```

---

### Issue 2: DNS Not Resolving

#### Symptoms:
- `nslookup: can't resolve`
- Malware unable to reach C2 servers
- `getaddrinfo failed` errors

#### Diagnosis:

```bash
# Test DNS from host
nslookup example.com
dig @127.0.0.1 example.com
host example.com

# Test DNS from INetSim container
docker exec inetsim-server nslookup example.com 127.0.0.1
docker exec inetsim-server dig @127.0.0.1 example.com

# Check INetSim logs
tail -f shared/logs/inetsim/inetsim.log | grep -i "dns"

# Check iptables DNS rules
sudo iptables -t nat -L OUTPUT -n | grep 53
```

#### Solutions:

**A) INetSim DNS service not responding**
```bash
# Check if port 53 is actually listening
docker exec inetsim-server netstat -tlnup | grep 53
docker exec inetsim-server ss -tlnup | grep 53

# Check service startup
docker-compose logs inetsim | grep -i "dns\|service\|error"

# Check DNS configuration
docker exec inetsim-server cat /etc/inetsim/inetsim.conf | grep "^service_binds\|^dns_"
```

**B) Wrong DNS server address**
```bash
# Verify INetSim container IP
docker inspect inetsim-server -f '{{.NetworkSettings.Networks.malware_lab.IPAddress}}'
# Should return: 172.20.0.2

# Check routing rules
sudo iptables -t nat -L OUTPUT -n -v | grep -E "53|DNS"

# If wrong IP, update iptables
sudo bash scripts/setup-routing.sh

# Or manually fix
sudo iptables -t nat -D OUTPUT -p udp --dport 53 -j DNAT --to 172.20.0.2:53
```

**C) dns_default_ip configuration**
```bash
# Check INetSim config
docker exec inetsim-server grep "dns_default_ip" /etc/inetsim/inetsim.conf

# Should be: dns_default_ip 172.20.0.2

# Update if needed
docker exec inetsim-server bash -c \
  'sed -i "s/^dns_default_ip.*/dns_default_ip 172.20.0.2/" /etc/inetsim/inetsim.conf'

# Restart service
docker-compose restart inetsim
```

**D) systemd-resolved interfering (Linux)**
```bash
# Check if systemd-resolved is running
sudo systemctl status systemd-resolved

# Stop it
sudo systemctl stop systemd-resolved
sudo systemctl disable systemd-resolved

# Set /etc/resolv.conf manually
echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf

# Retry DNS
nslookup example.com
```

---

### Issue 3: HTTP/HTTPS Not Intercepting

#### Symptoms:
- `curl: (7) Failed to connect to example.com port 80`
- HTTP requests not logged in FakeNet-NG
- Not reaching fake HTTP responses

#### Diagnosis:

```bash
# Test HTTP connectivity from host
curl -v http://localhost:80
curl -v https://localhost:443

# Test from container
docker exec fakenet-ng-server curl -v http://127.0.0.1:80
docker exec inetsim-server curl -v http://172.20.0.3

# Check if FakeNet-NG listening
docker exec fakenet-ng-server netstat -tlnup | grep -E "80|443"
docker exec fakenet-ng-server ss -tlnup | grep -E "80|443"

# Check FakeNet-NG logs
tail -f shared/logs/fakenet-ng/fakenet-ng.log
tail -f shared/logs/fakenet-ng/traffic.log
```

#### Solutions:

**A) FakeNet-NG not listening on ports**
```bash
# Check service startup logs
docker-compose logs fakenet-ng | tail -50

# Verify HTTP server running
docker exec fakenet-ng-server ps aux | grep -E "python|http"

# Check if port already in use inside container
docker exec fakenet-ng-server lsof -i :80 2>/dev/null || \
  docker exec fakenet-ng-server netstat -an | grep 80
```

**B) iptables routing not configured**
```bash
# Check current NAT rules
sudo iptables -t nat -L OUTPUT -n -v

# Setup routing
sudo bash scripts/setup-routing.sh

# Verify rules added
sudo iptables -t nat -L OUTPUT -n -v | grep -E "80|443"
```

**C) Traffic not reaching FakeNet-NG**
```bash
# Test direct connection to IP
curl -v http://172.20.0.3:80

# If works, problem is routing
# If doesn't work, problem is FakeNet-NG service

# Check FakeNet-NG network connectivity
docker exec fakenet-ng-server ping 172.20.0.1  # gateway
docker exec fakenet-ng-server ping 172.20.0.2  # INetSim
docker exec fakenet-ng-server curl http://127.0.0.1:80
```

**D) Port mapping conflict**
```bash
# Check if port 80 already exposed on host
sudo lsof -i :80
sudo netstat -tlnup | grep :80

# If in use, stop service and retry
sudo systemctl stop apache2  # or nginx, etc.

# Or use alternate port
# Modify docker-compose.yml:
ports:
  - "8888:80"
# Then test:
curl http://localhost:8888
```

---

### Issue 4: Container Exits Immediately

#### Symptoms:
- `Container exited with code 1`
- Logs show: `Error: exec format error`
- Services crash on startup

#### Diagnosis:

```bash
# Check detailed exit code and reason
docker inspect inetsim-server | grep -A 10 "State"

# View full logs
docker logs inetsim-server

# Check if entrypoint script has issues
docker exec inetsim-server bash -x /entrypoint.sh 2>&1 | head -50
```

#### Solutions:

**A) Script encoding issues (Windows CRLF)**
```bash
# Convert scripts to Unix line endings
dos2unix scripts/*.sh
dos2unix inetsim/entrypoint.sh
docker-compose build --no-cache

# Or manually fix
sed -i 's/\r$//' inetsim/entrypoint.sh
sed -i 's/\r$//' fakenet-ng/entrypoint.sh

docker-compose restart
```

**B) Missing dependencies**
```bash
# Check Dockerfile
more inetsim/Dockerfile

# Add missing packages to Dockerfile
RUN apt-get install -y \
    inetsim \
    net-tools \
    curl

# Rebuild
docker-compose build --no-cache inetsim
```

**C) Configuration file missing**
```bash
# Check if config file mounted
docker exec inetsim-server ls -la /etc/inetsim/

# Mount volume check in docker-compose
volumes:
  - ./inetsim/config/inetsim.conf:/etc/inetsim/inetsim.conf:ro

# Ensure file exists on host
ls -la inetsim/config/inetsim.conf
```

**D) Permission issues**
```bash
# Check entrypoint script permissions
ls -la inetsim/entrypoint.sh

# Should be executable (755)
chmod +x inetsim/entrypoint.sh
chmod +x fakenet-ng/entrypoint.sh

# Check volume permissions
chmod 755 shared/logs/inetsim
chmod 755 shared/logs/fakenet-ng

docker-compose up -d
```

---

### Issue 5: High Memory Usage / Container Crashes

#### Symptoms:
- Docker reports: `Killed`
- Memory usage grows continuously
- OOMKiller in system logs: `Memory cgroup out of memory`

#### Diagnosis:

```bash
# Monitor resource usage
docker stats

# Check logs for large requests
tail -n 1000 shared/logs/inetsim/inetsim.log | wc -l

# Check disk usage
du -sh shared/logs/

# Check memory limits
docker inspect inetsim-server | grep -i memory
```

#### Solutions:

**A) Log files too large**
```bash
# Clear old logs
rm shared/logs/*/*.log.* 2>/dev/null
truncate -s 0 shared/logs/inetsim/*
truncate -s 0 shared/logs/fakenet-ng/*

# Implement log rotation
cat > /etc/logrotate.d/malware-lab << 'EOF'
/path/to/shared/logs/*/*.log {
    daily
    rotate 7
    compress
    missingok
    notifempty
}
EOF

sudo logrotate -f /etc/logrotate.d/malware-lab
```

**B) Set memory limits**
```yaml
# docker-compose.yml
services:
  inetsim:
    mem_limit: 512m
    memswap_limit: 1g
  
  fakenet-ng:
    mem_limit: 1g
    memswap_limit: 2g
```

Then restart:
```bash
docker-compose up -d
```

**C) Traffic capture consuming resources**
```bash
# Disable PCAP if not needed
docker exec fakenet-ng-server bash -c \
  'sed -i "s/PacketCapture = True/PacketCapture = False/" /etc/fakenet/fakenet.conf'

docker-compose restart fakenet-ng
```

---

### Issue 6: Malware Can Reach External Internet

#### Symptoms:
- Malware reaching real websites
- Not contained to fake services
- Leaking to production network

#### Diagnosis:

```bash
# Check routing rules
sudo iptables -t nat -L OUTPUT -n | grep -c "malware_lab\|172.20"

# Check network policies
docker network inspect malware_lab | grep -i "internal\|isolated"

# Monitor live traffic
sudo tcpdump -i any -n host 172.20.0.2 or 172.20.0.3
```

#### Solutions:

**A) Enable network isolation**
```yaml
# docker-compose.yml - Restrict external connectivity
networks:
  malware_lab:
    internal: true  # Block external access
```

```bash
docker-compose down
docker-compose up -d
```

**B) Firewall rules missing for analyzer**
```bash
# Block direct internet access
sudo iptables -I FORWARD -i docker0 ! -o docker0 -j DROP
sudo iptables -I FORWARD -o docker0 ! -i docker0 -j DROP

# Save rules
sudo iptables-save > /etc/iptables/rules.v4
```

**C) Check for routing bypasses**
```bash
# Monitor all traffic
sudo tcpdump -i any -n -l | grep -v "172.20\|127.0"

# Kill suspicious connections
sudo ss -K dst 1.2.3.4 dport 80
```

---

## Logs Analysis Troubleshooting

### Issue: No Logs Being Generated

```bash
# 1. Check if INetSim logging is enabled
docker exec inetsim-server grep "^log_" /etc/inetsim/inetsim.conf

# 2. Verify log directory exists
docker exec inetsim-server ls -la /var/log/inetsim/

# 3. Check file permissions
docker exec inetsim-server ls -la /var/log/inetsim/
# Should be writable by inetsim user

# 4. Re-enable logging
docker exec inetsim-server bash -c \
  'sed -i "s/^#log_level.*/log_level debug/" /etc/inetsim/inetsim.conf'

docker-compose restart inetsim
```

### Issue: Logs Not Syncing to Host

```bash
# Check volume mount
docker exec inetsim-server mount | grep "/var/log/inetsim"

# Verify host path
ls -la shared/logs/inetsim/

# Check permissions
sudo chown $USER shared/logs/inetsim
chmod 755 shared/logs/inetsim

# Force log flush
docker exec inetsim-server sync
```

### Issue: PCAP File Corrupted

```bash
# Verify file format
file shared/logs/fakenet-ng/traffic.pcap

# Check with capinfos
capinfos shared/logs/fakenet-ng/traffic.pcap

# Attempt recovery
tcpdump -r shared/logs/fakenet-ng/traffic.pcap -w recovered.pcap

# Fallback: Convert to human-readable
tcpdump -r shared/logs/fakenet-ng/traffic.pcap -A > traffic.txt
```

---

## Network Troubleshooting

### DNS Not Working from Host

```bash
# Test host DNS
nslookup example.com
# Should resolve via INetSim (172.20.0.2)

# Check default nameserver
cat /etc/resolv.conf

# Must have:
nameserver 127.0.0.1

# If missing, add it
echo "nameserver 127.0.0.1" | sudo tee -a /etc/resolv.conf
```

### Container-to-Container Communication Failing

```bash
# Test ping
docker exec inetsim-server ping 172.20.0.3
docker exec fakenet-ng-server ping 172.20.0.2

# Test curl between services
docker exec inetsim-server curl http://fakenet-ng:80
docker exec fakenet-ng-server curl http://inetsim:80

# Check DNS resolution by name
docker exec inetsim-server nslookup fakenet-ng 127.0.0.11

# Fix: Ensure DNS server configured
docker-compose down
docker-compose up -d
```

### Host Cannot Reach Containers

```bash
# Try pinging container IP directly
ping 172.20.0.2

# If fails, check Docker network
docker network inspect malware_lab

# Check if Docker bridge exists
ip link show docker0
ifconfig docker0

# Recreate network if broken
docker network rm malware_lab
docker network create \
  --driver bridge \
  --subnet 172.20.0.0/24 \
  malware_lab
```

---

## Performance Troubleshooting

### Slow DNS Resolution

```bash
# Benchmark DNS queries
docker exec inetsim-server bash -c 'for i in {1..10}; do time dig @127.0.0.1 example.com; done'

# Check CPU usage
docker stats inetsim-server

# Reduce TTL for faster updates
docker exec inetsim-server sed -i 's/dns_default_ttl.*/dns_default_ttl 60/' /etc/inetsim/inetsim.conf

# Restart service
docker-compose restart inetsim
```

### Slow HTTP Responses

```bash
# Test response time
curl -w "@-" << 'EOF' -o /dev/null -s http://example.com
    time_namelookup:  %{time_namelookup}\n
       time_connect:  %{time_connect}\n
    time_appconnect:  %{time_appconnect}\n
   time_pretransfer:  %{time_pretransfer}\n
      time_redirect:  %{time_redirect}\n
 time_starttransfer:  %{time_starttransfer}\n
                    ----------\n
         time_total:  %{time_total}\n
EOF

# Check FakeNet-NG resource usage
docker stats fakenet-ng-server

# Check for bottlenecks in logs
grep "too many connections\|timeout\|error" shared/logs/fakenet-ng/*.log
```

---

## Getting Help

### Collect Diagnostic Information

```bash
# Create diagnostic bundle
bash -x << 'DIAG'
mkdir -p diagnostic-bundle
cd diagnostic-bundle

# Docker info
docker info > docker-info.txt
docker ps -a > containers.txt
docker network ls > networks.txt

# Container logs
docker-compose logs --no-color > docker-compose.log

# System info
uname -a > system.txt
free -h > memory.txt
df -h > disk.txt

# Networking
sudo iptables -t nat -L > iptables-nat.txt
ip route show > routes.txt
netstat -tlnp > netstat.txt 2>/dev/null || ss -tlnp > netstat.txt

# Sample logs
cp -r shared/logs logs-backup/

echo "Diagnostic bundle created: diagnostic-bundle/"
DIAG
```

### Report Format

When reporting issues, include:
1. OS and Docker version: `docker version`
2. All diagnostic files from bundle above
3. Exact steps to reproduce
4. Expected vs actual behavior
5. Relevant log excerpts (attach full logs)

---

## Quick Reference Checks

### Health Check Script

```bash
#!/bin/bash
echo "=== Docker Status ==="
docker-compose ps

echo -e "\n=== Network ==="
docker network inspect malware_lab | grep -E "Gateway|Subnet"

echo -e "\n=== INetSim ==="
docker exec inetsim-server nc -u -zv 127.0.0.1 53 && echo "✓ DNS" || echo "✗ DNS"

echo -e "\n=== FakeNet-NG ==="
docker exec fakenet-ng-server nc -zv 127.0.0.1 80 && echo "✓ HTTP" || echo "✗ HTTP"

echo -e "\n=== Routing ==="
sudo iptables -t nat -L OUTPUT -n | grep DNAT | wc -l && echo "✓ Routes configured"

echo -e "\n=== Disk Usage ==="
du -sh shared/logs/*

echo -e "\n=== Done ==="
```

Save as `health-check.sh` and run regularly:
```bash
chmod +x health-check.sh
./health-check.sh
```

---
**Last Updated:** February 2026
**Status:** Production Ready
