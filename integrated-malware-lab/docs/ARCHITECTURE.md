# Integrated Malware Analysis Lab - Architecture & Design

## System Architecture

### High-Level Overview

```
┌────────────────────────────────────────────────────────────────┐
│                    HOST SYSTEM                                 │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  iptables/Native Routing Layer                          │ │
│  │  - DNS (53) → 172.20.0.2 (INetSim)                     │ │
│  │  - HTTP (80) → 172.20.0.3 (FakeNet-NG)                │ │
│  │  - HTTPS (443) → 172.20.0.3 (FakeNet-NG)              │ │
│  │  - SMTP (25) → 172.20.0.2 (INetSim)                   │ │
│  │  - FTP (21) → 172.20.0.2 (INetSim)                    │ │
│  └──────────────────────────────────────────────────────────┘ │
│                           ↓ ↓ ↓                               │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │          Docker Bridge Network (172.20.0.0/24)         │ │
│  │                                                          │ │
│  │  ┌──────────────────┐          ┌──────────────────┐    │ │
│  │  │    INetSim       │          │   FakeNet-NG     │    │ │
│  │  │  172.20.0.2      │          │  172.20.0.3      │    │ │
│  │  │                  │────────→ │                  │    │ │
│  │  │  DNS Master      │ fallback │  HTTP/HTTPS      │    │ │
│  │  │  SMTP/FTP        │          │  Advanced Traffic│    │ │
│  │  │  HTTP/HTTPS      │          │  Analysis        │    │ │
│  │  │  Fallback        │          │  Response Inject │    │ │
│  │  └──────────────────┘          └──────────────────┘    │ │
│  │                                                          │ │
│  │  ┌──────────────────┐  (Optional)                      │ │
│  │  │  Analyzer        │                                  │ │
│  │  │  Container       │                                  │ │
│  │  │  172.20.0.x      │                                  │ │
│  │  └──────────────────┘                                  │ │
│  │                                                          │ │
│  └──────────────────────────────────────────────────────────┘ │
│                           ↓ ↓ ↓                               │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │  Logging & Monitoring Layer                             │ │
│  │  - shared/logs/inetsim/                                │ │
│  │  - shared/logs/fakenet-ng/                             │ │
│  │  - shared/logs/traffic.pcap                            │ │
│  └──────────────────────────────────────────────────────────┘ │
└────────────────────────────────────────────────────────────────┘
```

## Network Topology

### Docker Network Configuration

```
┌─────────────────────────────────────────────────┐
│  Docker Bridge: malware_lab                     │
│  Subnet: 172.20.0.0/24                          │
│  Gateway: 172.20.0.1                            │
│                                                 │
│  IP Space:                                      │
│  172.20.0.1     - Gateway (Docker bridge)       │
│  172.20.0.2     - INetSim                       │
│  172.20.0.3     - FakeNet-NG                    │
│  172.20.0.10+   - Available for analyzers       │
│  172.20.0.254   - Broadcast                     │
│                                                 │
│  Routing:                                       │
│  - Internal Docker DNS: 127.0.0.11:53           │
│  - INetSim DNS: 172.20.0.2:53                   │
│                                                 │
│  Network Features:                              │
│  - Bridge driver                                │
│  - MTU: 1500                                    │
│  - No external routing by default               │
└─────────────────────────────────────────────────┘
```

### Port Mapping Strategy

#### INetSim Port Assignment
```
Service      | Container Port | Host Port | Protocol | Purpose
─────────────┼────────────────┼───────────┼──────────┼─────────────────
DNS          | 53/UDP         | 53/UDP    | UDP/TCP  | Primary DNS
DNS          | 53/TCP         | 53/TCP    | UDP/TCP  | Primary DNS
SMTP         | 25/TCP         | 25/TCP    | TCP      | Email simulation
FTP          | 21/TCP         | 21/TCP    | TCP      | File transfer
HTTP         | 80/TCP         | 8080/TCP  | TCP      | HTTP fallback
HTTPS        | 443/TCP        | 8443/TCP  | TCP      | HTTPS fallback
Unspecified  | All            | Routing   | All      | iptables → 172.20.0.2
```

#### FakeNet-NG Port Assignment
```
Service      | Container Port | Host Port | Protocol | Purpose
─────────────┼────────────────┼───────────┼──────────┼─────────────────
HTTP         | 80/TCP         | 80/TCP    | TCP      | Primary HTTP
HTTPS        | 443/TCP        | 443/TCP   | TCP      | Primary HTTPS
Alt HTTP     | 8000/TCP       | 8000/TCP  | TCP      | Alternative HTTP
Alt HTTP     | 8080/TCP       | 8080/TCP  | TCP      | Alternative HTTP
Alt HTTP     | 8888/TCP       | 8888/TCP  | TCP      | Alternative HTTP
Alt HTTPS    | 8443/TCP       | 8443/TCP  | TCP      | Alternative HTTPS
Custom       | 9000/TCP       | 9000/TCP  | TCP      | Custom services
```

## Data Flow

### DNS Resolution Flow

```
┌──────────────┐
│ Malware      │
│ Queries DNS  │ example.com?
└──────┬───────┘
       │
       ↓ (53/UDP)
┌──────────────────────────────┐
│ Host iptables Rules          │ iptables -t nat -A OUTPUT \
│ (DNS Redirection)            │   -p udp --dport 53 \
│                              │   -j DNAT --to 172.20.0.2
└──────┬───────────────────────┘
       │
       ↓ (Redirected to 172.20.0.2:53)
┌──────────────────────────────┐
│ INetSim DNS Server           │ 1. Check DNS cache
│ (172.20.0.2:53)              │ 2. Apply wildcard rules
└──────┬───────────────────────┘ 3. Return A record
       │                         4. Log query
       │ 172.20.0.2              5. Send response
       ↓
┌──────────────┐
│ Malware      │
│ Receives:    │
│ example.com  │
│ = 172.20.0.x │
└──────────────┘
```

### HTTP/HTTPS Interception Flow

```
┌──────────────┐
│ Malware      │
│ GET /api     │ http://example.com/api
└──────┬───────┘
       │
       ↓ (80/TCP)
┌──────────────────────────────┐
│ Host iptables Rules          │ iptables -t nat -A OUTPUT \
│ (HTTP Redirection)           │   -p tcp --dport 80 \
│                              │   -j DNAT --to 172.20.0.3
└──────┬───────────────────────┘
       │
       ↓ (Redirected to 172.20.0.3:80)
┌──────────────────────────────┐
│ FakeNet-NG HTTP Server       │ 1. Parse HTTP request
│ (172.20.0.3:80)              │ 2. Check response patterns
└──────┬───────────────────────┘ 3. Generate fake response
       │                         4. Log request/response
       │                         5. Capture traffic (PCAP)
       │ Fake response            6. Send to malware
       ↓
┌──────────────┐
│ Malware      │
│ Receives:    │
│ Fake data    │
└──────────────┘
```

### Fallback Service Flow (HTTP → fallback)

```
┌─────────────────────────────────────┐
│ FakeNet-NG HTTP Server              │
│ (Handles primary HTTP requests)     │
│                                     │
│ If pattern not matched:             │
│ └─ ForwardToINetSim = True         │
└────────┬────────────────────────────┘
         │
         ↓ (Forward to fallback)
┌─────────────────────────────────────┐
│ INetSim HTTP Server (Port 80)        │
│ (Handles unmatched requests)        │
│                                     │
│ 1. Check fakefile.conf              │
│ 2. Serve appropriate file           │
│ 3. Log request                      │
└────────┬────────────────────────────┘
         │
         ↓ (Response)
┌─────────────────────────────────────┐
│ Malware receives fake file response │
└─────────────────────────────────────┘
```

## Component Details

### INetSim - DNS Server & Basic Services

#### Responsibilities:
1. **DNS Resolution (Primary)**
   - Listen on 0.0.0.0:53 (UDP/TCP)
   - Wildcard DNS responses
   - TTL: 3600 seconds (configurable)
   - Logging all queries

2. **SMTP Service**
   - Listen on 0.0.0.0:25
   - Fake mail server responses
   - No actual mail sending
   - Full conversation logging

3. **FTP Service**
   - Listen on 0.0.0.0:21
   - Fake file listing responses
   - File download simulation
   - Login attempt logging

4. **HTTP/HTTPS Fallback**
   - Listen on 0.0.0.0:80, 0.0.0.0:443
   - Serve fake files from fakefile.conf
   - Handles unmatched HTTP requests
   - Response logging

#### Configuration Structure:
```
inetsim/
├── Dockerfile              # Base image: Ubuntu 22.04
├── entrypoint.sh          # Startup script
└── config/
    ├── inetsim.conf       # Main configuration
    └── fakefile.conf      # Fake files mapping
```

#### Key Configuration Parameters:
```ini
# Service bindings
service_binds 0.0.0.0:53    # DNS
service_binds 0.0.0.0:25    # SMTP
service_binds 0.0.0.0:21    # FTP
service_binds 0.0.0.0:80    # HTTP
service_binds 0.0.0.0:443   # HTTPS

# DNS settings
dns_default_ip 172.20.0.2
dns_bind_redirect_enable 1
dns_default_ttl 3600

# Logging
log_file /var/log/inetsim/inetsim.log
log_level debug
log_traffic 1
```

#### Log Output:
```
[2026-02-12 10:30:45] DNS Query: example.com A → 172.20.0.2
[2026-02-12 10:30:46] HTTP Request: GET / from 172.20.0.254
[2026-02-12 10:30:47] SMTP Connection: MAIL FROM: <sender@example.com>
```

### FakeNet-NG - Advanced HTTP/HTTPS Analysis

#### Responsibilities:
1. **HTTP/HTTPS Interception (Primary)**
   - Listen on 0.0.0.0:80, 0.0.0.0:443
   - Transparent traffic interception
   - SSL/TLS certificate spoofing (with custom certs)
   - Request/response manipulation

2. **Advanced Response Handling**
   - Parse request patterns
   - Inject custom responses
   - API response simulation
   - Binary content serving

3. **Traffic Analysis & Logging**
   - Detailed request/response logging
   - PCAP file generation
   - Behavioral pattern detection
   - C2 communication tracking

4. **Service Compatibility**
   - Multi-format support (JSON, XML, HTML, etc.)
   - Custom handler registration
   - Graceful fallback to INetSim

#### Configuration Structure:
```
fakenet-ng/
├── Dockerfile                    # Base image: Ubuntu 22.04
├── entrypoint.sh                # Startup script
├── config/
│   ├── fakenet.conf             # Main configuration
│   └── responses_config.py       # Custom response handlers
└── certs/                        # SSL/TLS certificates
    ├── server.pem               # Server certificate
    └── server.key               # Private key
```

#### Response Handler Pattern:
```python
RESPONSE_HANDLERS = {
    'json': {
        'pattern': r'.*\.json.*',
        'content': '{"status": "success"}',
        'content_type': 'application/json'
    },
    'exe': {
        'pattern': r'.*\.(exe|dll).*',
        'content': b'MZ\x90...',  # Binary content
        'content_type': 'application/octet-stream'
    }
}
```

#### Log Output:
```
[2026-02-12 10:30:50] HTTP GET /api/check HTTP/1.1
[2026-02-12 10:30:50]   User-Agent: Mozilla/5.0
[2026-02-12 10:30:50]   Response: 200 OK
[2026-02-12 10:30:50]   Content: {"status": "success"}
```

## Port Conflict Resolution

### Problem Statement:
Both INetSim and FakeNet-NG need to listen on standard ports:
- Port 80 (HTTP)
- Port 443 (HTTPS)
- Port 53 (DNS)

### Solution Architecture:

#### Strategy 1: Static IP Assignment (IMPLEMENTED)
```yaml
# docker-compose.yml
services:
  inetsim:
    networks:
      malware_lab:
        ipv4_address: 172.20.0.2
  
  fakenet-ng:
    networks:
      malware_lab:
        ipv4_address: 172.20.0.3
```

**Advantage:**
- Different IPs = can bind same port
- Container-to-container communication via IP/hostname
- No port mapping conflicts

#### Strategy 2: Host Routing via iptables (IMPLEMENTED)
```bash
# DNS: Redirect to INetSim
iptables -t nat -A OUTPUT -p udp \
  --dport 53 -j DNAT --to 172.20.0.2:53

# HTTP: Redirect to FakeNet-NG
iptables -t nat -A OUTPUT -p tcp \
  --dport 80 -j DNAT --to 172.20.0.3:80

# HTTPS: Redirect to FakeNet-NG
iptables -t nat -A OUTPUT -p tcp \
  --dport 443 -j DNAT --to 172.20.0.3:443
```

**Advantage:**
- Traffic automatically routing
- Malware doesn't need special config
- Transparent redirection

#### Strategy 3: Port Priority Distribution (PROVIDED)
```
INetSim                FakeNet-NG
172.20.0.2            172.20.0.3
─────────────         ─────────────
53/UDP    (DNS)       80/TCP    (HTTP primary)
53/TCP    (DNS)       443/TCP   (HTTPS primary)
25/TCP    (SMTP)      8000/TCP  (Alt HTTP)
21/TCP    (FTP)       8080/TCP  (Alt HTTP)
80/TCP    (fallback)  8443/TCP  (Alt HTTPS)
443/TCP   (fallback)  8888/TCP  (Alt HTTP)
```

## Logging & Monitoring Strategy

### Log Hierarchy

```
shared/logs/
├── inetsim/
│   ├── inetsim.log          # Main service log
│   ├── inetsim.stat         # Statistics
│   └── [service].log        # Per-service logs
│
└── fakenet-ng/
    ├── fakenet-ng.log       # Main service log
    ├── traffic.log          # Traffic details
    ├── detail.log           # Request/response details
    └── traffic.pcap         # Packet capture
```

### Log Format Specification

#### INetSim Log Format
```
[timestamp] [level] [service] [action]: [details]
[2026-02-12 10:30:45] DEBUG DNS Query: example.com (A) → 172.20.0.2
[2026-02-12 10:30:46] INFO HTTP Connection: GET / HTTP/1.1
[2026-02-12 10:30:47] DEBUG SMTP: MAIL FROM <sender@example.com>
```

#### FakeNet-NG Log Format
```
[timestamp] [level] [method] [path] [protocol]
[2026-02-12 10:30:50] INFO GET /api/check HTTP/1.1
    Headers: User-Agent=Mozilla/5.0, Host=api.example.com
    Response: 200 OK, Content-Type: application/json
    Body: {"status": "success"}
```

### PCAP Analysis

```bash
# View packet summary
tcpdump -r traffic.pcap -n

# Export HTTP requests/responses
tcpdump -A -r traffic.pcap 'tcp port 80' | grep -E "^[A-Z]" | head -20

# Filter by protocol
tcpdump -r traffic.pcap 'dns'      # DNS packets
tcpdump -r traffic.pcap 'tcp port 25'    # SMTP
tcpdump -r traffic.pcap 'tcp port 443'   # HTTPS
```

## Scaling & Extension

### Adding Analyzer Containers

```yaml
services:
  analyzer:
    image: ubuntu:22.04
    networks:
      malware_lab:
        ipv4_address: 172.20.0.10
    dns:
      - 172.20.0.2  # Use INetSim DNS
    volumes:
      - ./samples:/samples
    depends_on:
      - inetsim
      - fakenet-ng
```

### Custom Service Integration

To add new services (e.g., SMB, RDP):

1. **Create new container**
   ```yaml
   services:
     custom-service:
       build: ./custom-service
       networks:
         malware_lab:
           ipv4_address: 172.20.0.20
       ports:
         - "445:445"  # SMB
   ```

2. **Add routing rule (on host)**
   ```bash
   iptables -t nat -A OUTPUT -p tcp --dport 445 \
     -j DNAT --to 172.20.0.20:445
   ```

3. **Configure DNS (in INetSim)**
   ```ini
   service_binds 0.0.0.0:445
   ```

## Security Model

### Isolation Levels

1. **Network Level**
   - Docker bridge isolates containers
   - Host cannot directly access container ports
   - Explicit iptables rules control traffic

2. **Container Level**
   - Each service runs with minimal privileges
   - Resource limits (CPU, Memory)
   - Read-only volumes where possible

3. **Application Level**
   - Input validation in response handlers
   - Safe file serving (no directory traversal)
   - Limited shell access in containers

### Attack Surface

```
Potential Attack Vectors:
├── Malware breaking container escape
│   └── Mitigation: OS security patches + resource limits
├── DNS poisoning
│   └── Mitigation: Control all DNS responses
├── HTTP response injection
│   └── Mitigation: Whitelist patterns + validate content
└── Log file tampering
    └── Mitigation: Read-only log volumes + external backup
```

## Performance Considerations

### Resource Allocation

```
Container Resource Limits:
┌────────────────┬────────┬────────┐
│ Container      │ CPU    │ Memory │
├────────────────┼────────┼────────┤
│ INetSim        │ 1 core │ 512MB  │
│ FakeNet-NG     │ 1 core │ 1GB    │
│ Analyzer       │ 2 core │ 4GB    │
└────────────────┴────────┴────────┘
```

### Network Performance

```
Throughput Benchmarks (per service):
- DNS: ~1000 queries/sec
- HTTP: ~100 requests/sec
- HTTPS: ~50 requests/sec (SSL overhead)
- SMTP: ~10 connections/sec
- FTP: ~5 connections/sec
```

## Future Enhancement Points

1. **Kubernetes Support**
   - Convert docker-compose to Helm charts
   - Multi-node deployment
   - Service mesh integration

2. **Advanced Analysis**
   - Machine learning based detection
   - Behavioral graph generation
   - Automated threat classification

3. **Integration Points**
   - SIEM (Splunk, ELK)
   - Threat intelligence feeds
   - Automated incident response

4. **Performance Optimization**
   - Caching layer for repeated requests
   - Load balancing for multiple analyzers
   - GPU acceleration for analysis

---
**Architecture Version:** 1.0
**Last Updated:** February 2026
**Document Status:** Approved for Production
